<HTML>
<HEAD>
<TITLE>  Extracion de datos de pagos BNC  </TITLE>
<!-- <link rel="stylesheet" href="styles.css" > -->
<link rel="manifest" href="manifest.json">
<!-- <meta charset="iso-8859-1">  -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
<style>

input[type=number]{
font-size:2em;
width: 8em;
border: 2px solid red;
border-radius: 4px;
padding: 4px 4px;
  margin: 4px 0;
  box-sizing: border-box;
  background-color: #3CBC8D;
  color: red;

}

input[type=text]{
font-size:1em;
width: 10em;
border: 2px solid red;
border-radius: 4px;
padding: 4px 4px;
  margin: 4px 0;
  box-sizing: border-box;
  background-color: white;
  color: black;
}

input[type=email]{
font-size:1em;
width: 8em;
border: 2px solid red;
border-radius: 4px;
padding: 4px 4px;
  margin: 4px 0;
  box-sizing: border-box;
  background-color: #3CBC8D;
  color: red;
}

input[type=date]{
font-size:1em;
width: 12em;
border: 2px solid red;
border-radius: 4px;
padding: 4px 4px;
  margin: 4px 0;
  box-sizing: border-box;
   background-color: #3CBC8D;
  
  color: black;
}

select{
font-size:1em;
width: 10em;
border: 2px solid red;
border-radius: 8px;
padding: 4px 4px;
  margin: 4px 0;
  box-sizing: border-box;
  background-color: #3CBC8D;
  color: red;
}

input[type=text]:focus {
  background-color: lightblue;
}


</style>
<style>
body {
  font-family: "Lato", sans-serif;
}

.sidenav {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: #111;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
  text-align:left;
}

.sidenav a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;

  transition: 0.8s;
}

.sidenav a:hover {
  color: #f1f1f1;
}

.sidenav .closebtn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}

.micro {
   background-image:url(microphone.svg);
   width:30px;
	height:30px;
	font-size:16px;
	padding:0px 0px 0px 0px;
	background-size:30px 30px;
	background-position:-2px 0px;
    fill: green;

border-radius: 8px;
}
.divfondo {
   width:90%;
   background-color:#FFFDD0;
   border-radius: 8px;
padding: 6px 6px;
margin-left: 5px;
margin-right: 5px;
}
.micro:active {
background-color: lightgreen;
}
.btop{
font-size:2em;
border: 2px solid red;
border-radius: 8px;
padding: 4px 4px ;
  margin: 4px 0px ;
  box-sizing: border-box;
  background-color: orange;
  color: black;
}
.btop:active {background-color: lightgreen;}
.titulo{
color:blue;
}
.botonf{
font-size:0.8em;
border: 2px solid red;
border-radius: 4px;
padding: 8px 8px;
  margin: 8px 0;
  box-sizing: border-box;
  background-color: oldlace;
  color: black;
}
.tablefact {
padding: 0px 0px;
margin: 0px 0px;
font-size: 1em;
}
.botonfact{
width:20em;
font-size:0.8em;
text-align:left;
border: 2px solid red;
border-radius: 12px;
padding: 8px 8px;
  margin: 8px 0;
  box-sizing: border-box;
  background-color: #FFFDD0;
  color: black;
}
.botonf:active {background-color: lightgreen;}
.botonfact:active {background-color: lightgreen;}

#divdata {
position:fixed;
top:20%;
height: 70%;
width:95%;
overflow-y: scroll;
}

#footer {
  display: none;
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  background-color: blue;
  color: white;
  text-align: center;
  font-size:0.5em;
}
#menu {
  position: fixed;
  left: 0;
  top: 8%;
  width: 100%;
  background-color: white;
  color: white;
  text-align: center;
  font-size:0.5em; 
  visibility:visible;
}
#header {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  background-color: white;
  color: white;
  text-align: center;
  font-size:0.5em;
}
#div3 {
  position: fixed;
  left: 0;
  top: 90%;
  width: 100%;
  background-color: white;
  color: black;
  text-align: center;
  font-size:1em;
}
#div4 {
  position: fixed;
  left: 0;
  top: 30%;
  width: 100%;
  background-color: white;
  color: black;
  text-align: center;
  font-size:1em;
}
</style>
</HEAD>

<script type="text/javascript" src="selectFile.js"></script>

<script type="text/javascript">
const t_c=new Map();
Fecha_hora='';
t_c.set('584144202172','Alejandro Naranjo');
t_c.set('01340067960673057959','Alexis Pool personal');
t_c.set('584121308516','Alexis Pool personal');
t_c.set('01020406290000103046','Alianza cafe');
t_c.set('01910027851127292097','Alvaro Jardim');
t_c.set('584124067144','Ana Beatriz sobrina');
t_c.set('584244244676','Ana Luisa Caldera');
t_c.set('584126153631','Anderson Pita');
t_c.set('584144853637','Andres Mijares');
t_c.set('AREPA EL PAISITA','AREPA EL PAISITA');
t_c.set('01740124621244237572','AREPA EL PAISITA');
t_c.set('01910027801127274106','Armando Pita');
t_c.set('584125012908','Bodega Felix');
t_c.set('584144973532','Bodega Marcos');
//t_c.set('584244541829','Bodega Moya');
t_c.set('584244469305','Bodega Moya');
t_c.set('584244285516','Bodega Moya');
t_c.set('01140162731620081589','Bodegon JR');
t_c.set('584242069117','Bodegon JR');
t_c.set('584144033621','Bodegon JR');
t_c.set('584125091226','Bodegon JR');
t_c.set('584128552592','Braulio De Abreu');
t_c.set('584244021067','Inversiones del Valle');//Bull buja
t_c.set('584144791658','Bull Pen');
t_c.set('584140412168','Bull Pen');
t_c.set('584244063691','Bull Pen');
t_c.set('584145822722','Licoreria Canapiales');
t_c.set('584141863212','Licoreria Canapiales');
t_c.set('584128529762','Carlos Hernandez');
t_c.set('584124346526','Carlos Hernandez');
t_c.set('584144978575','Carlos Hernandez');
t_c.set('584127848852','Carlos Hernandez');
t_c.set('584145936335','Carlos Hernandez');
t_c.set('584124500070','Carlos Hernandez');
t_c.set('584124336110','Carlos Hernandez');
t_c.set('584140487771','Carlos Hernandez');
//t_c.set('01050041981041334605','Carlos Hernandez');
t_c.set('584125026326','Carlos Hernandez');
t_c.set('584124544871','Carlos Hernandez');
t_c.set('584128314388','Carniceria la emboscada');
t_c.set('01910243272100053204','Carniceria la emboscada');
t_c.set('584244392499','Star market place CA');
t_c.set('584121396715','Casa Mayor');
t_c.set('01910148722100041321','Centeno Wilmer');
t_c.set('01050758831758117052','Churumal');
t_c.set('584124548273','Ciudad Market');
t_c.set('01340419414191032727','Club la emboscada');
t_c.set('01340419414193020946','Club la emboscada');
t_c.set('584124304844','Colegio los pinos');
t_c.set('584125100639','Colegio Teresiano');
t_c.set('584149479895','Darley De Abreu');
t_c.set('584148737746','Denis Supervisor');
t_c.set('584146784460','Licoreria El Chivato');
t_c.set('584140430489','El sabor de Lili');
t_c.set('584124613036','El sazon de la abuela');
t_c.set('01020857280000164412','El sazon de la abuela')
t_c.set('584149487610','igual que en casa')
t_c.set('01080923150100080735','Rincon Italiano')
t_c.set('584143419930','Panaderia hogar pan')
t_c.set('584244988456','Cesar Perrero Paveca')
t_c.set('584144791429','Esposa de Ludi');
t_c.set('01380008190080143008','Euro Licores');
t_c.set('01680052095101387169','Euro Licores');
t_c.set('584144408427','Euro Licores');
t_c.set('584124593210','Fotocopia los pinos');
t_c.set('01910148792100048675','Garcia T. Antonio J.');
t_c.set('584142487797','Guaicamari');
t_c.set('584244078576','Guaicamari');
t_c.set('01340791657911005013','Guaicamari');
t_c.set('584144390582','Haydee Martinez');
t_c.set('584145936061','Heladeria Unicasa');
t_c.set('01910243222100017346','Heladeria Unicasa');
t_c.set('HOTEL GOLD','Hotel Gold');
t_c.set('01380008100080195830','Hotel Gold');
t_c.set('584244188209','Lo mejor del toco');
//t_c.set('584244021067','Inversiones del Valle');// Bull buja
t_c.set('01050041981041334605','Keny Pita');
t_c.set('584122739761','Mini market Kapf');
t_c.set('584122853554','Bodegon La cuna');
t_c.set('584128311132','Bodegon La cuna');
t_c.set('584144202063','Bodegon La cuna');
t_c.set('584128568459','La Ermita');
t_c.set('01020152720000574471','La Ermita');
t_c.set('01020142000100004572','Bodegon La luz');
t_c.set('01910027812127041189','Leticia');
t_c.set('584145939707','Licoreria Yorman');
t_c.set('584124203948','Licoreria San Rafael');
t_c.set('584124203947','Licoreria San Rafael');
t_c.set('584140422874','Licoreria San Rafael');
t_c.set('01340464034643019505','Liconan');
t_c.set('01740124661244144208','Liconan');
t_c.set('584144807588','Liconan');
t_c.set('584244342559','Liconan');
t_c.set('584121401869','Licoreria Baco');
t_c.set('01340346533461027171','Licoreria Baco');
t_c.set('584140459037','Luncheria Unicasa');
t_c.set('584144145440','Licoreria Malave');// Simon
t_c.set('584124072605','Bodega Claudia');// Claudia
t_c.set('01910027821127272510','Martinez B. Antonio');
t_c.set('01020857200000136026','Materiales Alianza');
t_c.set('01020114420000595059','Materiales Alianza');
t_c.set('01020114420000585059','Materiales Alianza');
t_c.set('01630265142653009253','Materiales Alianza');
t_c.set('IGRIVAL','Materiales Alianza');
t_c.set('584124097520','Maximum Carnes');
t_c.set('01020430580000079701','Maximum Carnes');
t_c.set('01020152750000507309','Mc Center Pool');
t_c.set('01380008190085381160','Mc Center Pool');
t_c.set('01380008120080196594','Mc Center Pool');
t_c.set('584144063036','Mary Pita');
t_c.set('584128999549','Mini Market PM03');
t_c.set('584127820477','Negro Primero');
t_c.set('584140389048','Negro Primero');
t_c.set('584244069799','Negro Primero');
t_c.set('01910148722100062413','Negro Primero');
t_c.set('01020391140000877505','Noir Guacara');
t_c.set('01341089560001005231','Noir Guacara');
t_c.set('01341089560001006542','Noir Guacara');
t_c.set('584144185616','Pan Center');
t_c.set('01910203342100024431','Panaderia la Unidad 2012');
t_c.set('01910203382100035457','Francis Pan');
t_c.set('01690002881000458707','Pan. Trigo Pan SRL');
t_c.set('TRIGOPAN','Pan. Trigo Pan SRL');
t_c.set('584167465405','Panaderia Renacer');
t_c.set('584126903878','Peluquero Roro');
t_c.set('PEPSI COLA','PEPSI COLA');
t_c.set('01140226742260075694','Licoreria Piedra pintada');
t_c.set('01380008100080137300','Licoreria Piedra pintada');
t_c.set('01340419414191041936','Licoreria Piedra pintada');
t_c.set('01140150341500503056','Pizzeria Traqui');
t_c.set('584144314028','Quiosco Sara');
t_c.set('584123441007','Rafael Pita');
t_c.set('584148944498','Rafael Pita');
t_c.set('CREACIONES PITA','Rafael Pita');
t_c.set('584128808329','Rest. Pio pio');
t_c.set('01910369212100007816','Rest. Pio pio');
t_c.set('01910362502100027278','Rest. Pio pio');
t_c.set('01080083840100274933','Rest. Pio pio'); 
t_c.set('01910107072100074333','Rest. Pio pio');
t_c.set('01340592135921000679','Vama Cafe');
t_c.set('01050758831758092394','Vama Cafe');
t_c.set('584244541829','Roger Dona');
t_c.set('01750062720073634371','Rosa De Abreu');
t_c.set('584124566786','El sazon de la abuela');
t_c.set('584244203234','Sosa Almacen');
t_c.set('584144397087','Tequenack');
t_c.set('01340153541531021352','Santa Fe market');
t_c.set('01340419444191042090','Venvidrio');
t_c.set('584144159903','Venvidrio');
t_c.set('584120386419','Venvidrio');
t_c.set('584121589089','La gran parada');// Vicente
t_c.set('584144125422','Inversiones Vilmar');
t_c.set('01080927480100022435','Vikingo');
t_c.set('584129546298','Kiosko Hospital');
t_c.set('584124465846','Yoni el cauchero');
t_c.set('584244030883','Energym Coffe');
t_c.set('584121978971','Marlin hija Sonia');
t_c.set('01050137711137023074','Maxi Carnes Vigirima');
t_c.set('584146443242','Farmacia Sunacar');
t_c.set('ISO HOME','Iso Home');
dat_especial=["AREPA EL PAISITA","IGRIVAL","HOTEL GOLD","TRIGOPAN","PEPSI COLA","CREACIONES PITA","ISO HOME"];
const t_d=new Map();
/*t_d.set('27/12/2022',16.57);
t_d.set('26/12/2022',16.57);
t_d.set('25/12/2022',16.45);
t_d.set('24/12/2022',16.45);
t_d.set('23/12/2022',16.45);
t_d.set('22/12/2022',16.18);
*/
var productos=[];
function clickp_cliente(pos){
document.getElementById("div3").style.visibility='hidden';
const posic=document.getElementsByName("pcliente")[pos].offsetTop;
document.getElementById("lclientes").scrollTop=posic-30;
}

var lista_clientes=[];
function Selecciona_cliente(){
var textoT="";
var div3 = document.getElementById("div3");
div3.style="position: fixed;top :0px; left: 0px; width: 100%;height:80%;background-color: lightgray;color:white; text-align: left; border: 3px solid #73AD21;";
textoT+='<div style="position: fixed; text-align:right;background-color: gray;width:100%;">';
textoT+='<table width="100%"><tr>';
textoT+='<td style="width:70%;text-align:center;color:blue;" >Clientes</td>';
textoT+='<td width="10%"><button  title="Salir" onclick=quitar_div("div3");> x </button></td>';
textoT+='</tr></table></div><br>';
textoT+='<div style="overflow:auto;height:90%;font-size:0.8rem;">';
textoT+='<table width="100%">';
for (var i=0;i<lista_clientes.length;i++) {
textoT+='<tr style="font-size:1.2em;"><td style="color:black;background-color:SkyBlue;cursor:pointer;text-align:center;" onclick="clickp_cliente('+i+')";>'+lista_clientes[i]+'</td></tr>'; 
}
textoT+='</table></div>';
div3.innerHTML=textoT;
}


function Activalector_archivos(){
getFile2 = new selectFile;
getFile2.targets('choose2','selected');
archivos2=document.getElementById('choose2');
archivos2.value=null;
archivos2.addEventListener('change', Leer_Archivo, false);
getFile2.simulate();
}


function readFileAsText(file){
  return new Promise(function(resolve,reject){
  let fr = new FileReader();
  fr.onload = function(){
     resolve(fr.result);
   };
   fr.onerror = function(){
     reject(fr);
   };
   fr.readAsText(file);
   });
}
//function Leer_Archivo(e){}

function Leer_Archivo(e){
 var archivos=e.currentTarget.files;
var narch=archivos.length;
let readers=[];
 for(var f=0;f<narch;f++){
  readers.push(readFileAsText(archivos[f]));
 
  //console.log('nombre archivo'+archivos[f].lastModifiedDate);
  Fecha_hora=archivos[f].lastModifiedDate.toLocaleString('es-US',{});
 } 
 Promise.all(readers).then((values) => {
  var sep="&&&&";
  contenido='';
  for(var t=0;t<narch;t++){
     if (t!=0) {contenido+=sep+values[t]} else {contenido+=values[t];}
     }
 //console.log(contenido);
     procesa_contenido();
 });

}
var contenido='';
function procesa_archivo(e){
//contenido=e.target.result; 
//localStorage.setItem('Arch_datos_banco',contenido);
//procesa_contenido();
}

function fecha_mayor_igual(f1,f2){
var a2=f2.split('/');
var a1=f1.split('/');
 if (a2[2]>a1[2] || (a2[2]==a1[2] && a2[1]>a1[1]) || (a2[2]==a1[2] && a2[1]==a1[1]) && a2[0]>a1[0]) {return false; } else {return true;}
}

function muestra(num){
var texto='';
var div3=document.getElementById("div3");
texto+=pagos[num].motivo;
div3.innerHTML=texto;
}
function Obten_nombre(tel){
var clave=(tel).toString().trim();
var tmp=t_c.get(clave);
if (tmp==undefined) {tmp=clave;}
return tmp;
}

function genera_salida1(){
if (pagos.length>0) {
var divaux=document.getElementById("divdata");
var texto='';
pagos.sort(ordena_pagos);
var fecha_previa=pagos[0].fecha;
var nombre_previo=Obten_nombre(pagos[0].telf);
//var total_parcial=parseFloat(pagos[0].montodolar);
var total_parcial=0;

console.log('Fecha: '+fecha_previa+' Dolar BCV: '+pagos[0].dolar+' $');
texto+='<p style="text-align:center;font-size:1.5em;">'+'Fecha: '+fecha_previa+' Dolar BCV: '+pagos[0].dolar+' $'+'</p>';
texto+='<table width="100%">';

for (var i=0;i<pagos.length;i++){
colb=colorcuenta(pagos[i].tc);
// console.log('i: '+i);
 if (pagos[i].fecha!=fecha_previa) {
    fecha_previa=pagos[i].fecha;
    console.log('Fecha: '+fecha_previa+' Dolar BCV: '+pagos[i].dolar+' $');
    texto+='</table>';
    texto+='<p style="text-align:center;font-size:1.5em;">'+'Fecha: '+fecha_previa+' Dolar BCV: '+pagos[i].dolar+' $'+'</p>';

    texto+='<table width="100%">';
  }

texto+='<tr onclick="muestra('+i+')"; style="background-color:'+colb+';"><td>'+Obten_nombre(pagos[i].telf)+'</td><td>'+'&nbsp&nbsp'+pagos[i].montoBs+' Bs '+'</td><td>'+'&nbsp&nbsp'+pagos[i].montodolar+' $ '+'</td></tr>';

}
 texto+='</table>';
divaux.innerHTML=texto;
divaux.style.visibility="visible";
}
}

function quitar_div(div_b){
document.getElementById(div_b).style.visibility='hidden';
}
function borrar_pagos_hechos(){
localStorage.setItem('pagos_hechos_banco','');

}
function agrega_deuda(j){
var ind=Clientes.findIndex(x=>x.nombre==Obten_nombre(pagos[j].telf));
var valor=parseFloat(document.getElementById('intro').value);
Clientes[ind].deuda=(parseFloat(Clientes[ind].deuda)-valor).toFixed(2);
localStorage.setItem('Clientes_Pita',JSON.stringify(Clientes));
document.getElementById('deu').innerText='Deuda :'+Clientes[ind].deuda;
document.getElementById('intro').value='';
}

function agrega_pago(){
document.getElementById('intro').value=suma;
}
function muestra_deuda(j){
var divaux=document.getElementById("div4");
var texto='';
texto+='<div style="border: 5px solid red;">';
texto+='<p>'+Obten_nombre(pagos[j].telf)+'</p>';
Clientes=JSON.parse(localStorage.getItem('Clientes_Pita'));
var ind=Clientes.findIndex(x=>x.nombre==Obten_nombre(pagos[j].telf));
if (ind>=0) {
console.log(Clientes[ind].deuda);
texto+='<table width="100%"><tr>';
texto+='<td width="50%"><span id="deu"> Deuda :'+Clientes[ind].deuda+'</span></td>';
texto+='<td width="25%"><span id="abo"> Abono :'+suma+'</span></td>';
texto+='<td style="width:25%;text-align:rigth;"><button onclick=agrega_pago()>+</button></td>';
texto+='</tr></table>';
texto+='<input id="intro" type="text" value="0"><button onclick=agrega_deuda('+j+')>Ok</button><br>';
}
texto+='<button onclick=quitar_div("div4")>Salir</button>';
texto+='</div>';
divaux.innerHTML=texto;
divaux.style.visibility="visible";
}

function chequeado(o,pos){


if (o.checked) {
 var ind=pagos_hechos.findIndex(x=>x.fecha==pagos[pos].fecha && x.hora==pagos[pos].hora);
 if (ind<0) { pagos_hechos.push({"fecha":pagos[pos].fecha,"hora":pagos[pos].hora});
 localStorage.setItem('pagos_hechos_banco',JSON.stringify(pagos_hechos));}
 //Clientes[ind1].deuda=(parseFloat(Clientes[ind1].deuda)-parseFloat(pagos[pos].montodolar)).toFixed(2);
 //localStorage.setItem('Clientes_Pita',JSON.stringify(Clientes));
  o.parentElement.parentElement.style.color="white";} 
 else {
var ind=pagos_hechos.findIndex(x=>x.fecha==pagos[pos].fecha && x.hora==pagos[pos].hora);
  if (ind>=0) { pagos_hechos.splice(ind,1);
  localStorage.setItem('pagos_hechos_banco',JSON.stringify(pagos_hechos));}
  o.parentElement.parentElement.style.color="black";
}

}
function genera_salida2(){
for (var j=0;j<pagos.length;j++) {
 pos[j]=0;
}
suma=0;
document.getElementById('suma').innerText='Suma: '+suma.toFixed(2);
if (pagos.length>0) {
var divaux=document.getElementById("divdata");
divaux.style="position: fixed;top :20%; left: 0px; width: 100%;height:80%;background-color: lightgray;color:white; text-align: left; border: 3px solid #73AD21;overflow-y: scroll;";
var texto='';
texto+='<div style="position: fixed; text-align:right;background-color: gray;width:100%;">';
texto+='<table width="100%"><tr>';
texto+='<td style="width:70%;text-align:center;color:blue;" >Clientes</td>';
texto+='<td width="10%"><button  title="Nombre" onclick="Selecciona_cliente();" > Sel </button></td>';
texto+='<td width="10%"><button  title="Salir" onclick=quitar_div("divdata"); <button> x </button></td>';
texto+='</tr></table></div><br>';
texto+='<div id="lclientes" style="overflow:auto;height:90%;font-size:0.8rem;">';


 pagos.sort(ordena_pagos2);
var nombre_previo='';
var fecha_previa=pagos[0].fecha;
var total_parcial=0;
var montop='';
var cont_c=0;
lista_clientes=[];
 console.log( nombre_previo);
texto+='<p style="color:red;font-size:1.5em;text-align:center;">'+nombre_previo+'</p>';
for (var i=0;i<pagos.length;i++){
  
colb=colorcuenta(pagos[i].tc);

 if (Obten_nombre(pagos[i].telf)!=nombre_previo) {
  
    nombre_previo=Obten_nombre(pagos[i].telf);lista_clientes[cont_c]=nombre_previo;cont_c++;
    if (i!=0) {
      console.log(total_parcial.toFixed(2));
     //texto+='<p style="color:blue;">Fecha:'+fecha_previa+'Total parcial: '+montop.toFixed(2)+'</p>';
      fecha_previa=pagos[i].fecha;texto 
      //texto+='<p>Total: '+total_parcial.toFixed(2)+'</p>';
    }

    total_parcial=parseFloat(pagos[i].montodolar);
     montop=total_parcial;
    texto+='<p name="pcliente" onclick="muestra_deuda('+i+');" style="color:red;font-size:1.5em;text-align:center;">'+Obten_nombre(pagos[i].telf)+'</p>';
 
 } else { 
    total_parcial+=parseFloat(pagos[i].montodolar)
    if (pagos[i].fecha!=fecha_previa) { 
       //texto+='<p style="color:blue;"> Fecha:'+ fecha_previa+'Total parcial: '+montop.toFixed(2)+'</p>'; montop=parseFloat(pagos[i].montodolar)
       fecha_previa=pagos[i].fecha; 
     }  else  {
        montop+=parseFloat(pagos[i].montodolar);
        }
  }
console.log(pagos[i].fecha+' '+pagos[i].telf+' '+pagos[i].montoBs+' Bs '+pagos[i].montodolar+' $ ');
//texto+='<p>'+pagos[i].fecha+'&nbsp&nbsp'+pagos[i].hora.substring(0,5)+'&nbsp&nbsp'+pagos[i].telf+' '+pagos[i].montoBs+' Bs '+pagos[i].montodolar+' $ '+'</p>';
//texto+='<p style="background-color:'+colb+';" onclick=permuta(this,'+i+');>'+' '+pagos[i].fecha+'     '+pagos[i].montoBs+' Bs '+'     '+pagos[i].montodolar+' $ '+'</p>';
texto+='<table width="100%">';
var indip=pagos_hechos.findIndex(x=>x.fecha==pagos[i].fecha && x.hora==pagos[i].hora);
if (indip>=0) {texto+='<tr style="color:white; background-color:'+colb+';" ><td width="5%"> <input type="checkbox" checked onclick=chequeado(this,'+i+');>'+'</td>';}
  else {texto+='<tr style="color:black;background-color:'+colb+';" ><td width="5%"> <input type="checkbox" onclick=chequeado(this,'+i+');>'+'</td>';}
texto+='<td width="31%">'+'&nbsp&nbsp'+pagos[i].fecha+'</td>';
texto+='<td width="27%">'+'&nbsp&nbsp'+pagos[i].montoBs+' Bs '+'</td>';
texto+='<td width="27%" onclick="permuta(this,'+i+');">'+'&nbsp&nbsp'+pagos[i].montodolar+' $ '+'</td></tr></table>';

} // for i

 console.log(total_parcial.toFixed(2));
// texto+='<p>Fecha:'+fecha_previa;+'Total parcial: '+montop.toFixed(2)+'</p>';
     

//texto+='<p>Total :'+total_parcial.toFixed(2)+'</p>';
texto+='</div>';
divaux.innerHTML=texto;
divaux.style.visibility="visible";
}
}

function colorcuenta(C){
   if (C=='A') {return 'SkyBlue';} 
   if (C=='J') {return 'DodgerBlue';}
   if (C=='C') {return 'SteelBlue';}
}

function genera_salida3(){
if (pagos.length>0) {
var divaux=document.getElementById("divdata");
var texto='';
 pagos.sort(ordena_pagos3);
var fecha_previa=pagos[0].fecha;
var nombre_previo=Obten_nombre(pagos[0].telf);
var total_parcial=0;

console.log('Fecha: '+fecha_previa+' Dolar BCV: '+pagos[0].dolar+' $');
texto+='<p style="text-align:center;font-size:1.5em;">'+'Fecha: '+fecha_previa+' Dolar BCV: '+pagos[0].dolar+' $'+'</p>';
texto+='<table width="100%">';
for (var i=0;i<pagos.length;i++){
   colb=colorcuenta(pagos[i].tc);
if (pagos[i].fecha!=fecha_previa) {
    fecha_previa=pagos[i].fecha;
    console.log('Fecha: '+fecha_previa+' Dolar BCV: '+pagos[i].dolar+' $');
    texto+='</table>';
    texto+='<p style="text-align:center;font-size:1.5em;">'+'Fecha: '+fecha_previa+' Dolar BCV: '+pagos[i].dolar+' $'+'</p>';

    texto+='<table width="100%">';
  }
 texto+='<tr  onclick="muestra('+i+')"; style="background-color:'+colb+';"><td>'+Obten_nombre(pagos[i].telf)+'</td><td>'+'&nbsp&nbsp'+pagos[i].montoBs+' Bs '+'</td><td>'+'&nbsp&nbsp'+pagos[i].montodolar+' $ '+'</td></tr>';

}
 texto+='</table>';
divaux.innerHTML=texto;
divaux.style.visibility="visible";
}
}

var suma=0;
var Tipocuenta='';
var pos=[];
function permuta(o,ind){
//alert(ind+' '+pos[ind]);
pos[ind]=1-pos[ind];
if (pos[ind]==0) {o.style.color='black'} else {o.style.color='yellow'}
suma=0;
for (var i=0;i<pos.length;i++){
if (pos[i]==1) {suma+=parseFloat(pagos[i].montodolar)}
}
document.getElementById('suma').innerText='Suma: '+suma.toFixed(2);
}

function caso_especial(dato){
 var post;
 //console.log('Caso especial');
for (var i=0;i<dat_especial.length;i++) {
  post=dato.indexOf(dat_especial[i]);
  //console.log('post '+ post);
  if (post>0) {return dat_especial[i];}
 }
return dato;
}
var posi=0;
var pagos=[];
var domicilios=[];

var TC;
function procesa_contenido(){

function cumple1(value) {
if (value.indexOf("Abono Pago Movil")>0||value.indexOf("Credito Inmediato Recibido")>0 || (value.indexOf("TRANSFERENCIA RECIBIDA")>0 && value.indexOf("DE LA CUENTA NRO. 01910027801127274106")<0 && value.indexOf("DE LA CUENTA NRO. 01910148772100070936")<0) ) {return true;} else {return false;}
}
function cumple2(value) {
if (value.indexOf("Cargo Domiciliacion")>0 || value.indexOf("Cargo por Domiciliacion")>0) {return true;} else {return false;}
}
var nsem;
var sem;

//console.log(contenido);
var archivos=contenido.split("&&&&");

for (var jj=0;jj<archivos.length;jj++) {
var lineas=archivos[jj].split("\r\n");

 var post=lineas[0].indexOf('01910027801127274106');
if (post>=0) {Tipocuenta="Cuenta de Ahorro"; TC='A';}
 var post=lineas[0].indexOf('01910027822127000477');
if (post>=0) {Tipocuenta="Cuenta Juridica";TC='J';}
 var post=lineas[0].indexOf('01910148772100070936');
if (post>=0) {Tipocuenta="Cuenta Corriente";TC='C';}

var result=lineas.filter(cumple1)
var result_2=lineas.filter(cumple2)
//console.log(result_2);
//console.log(result);
//Domicilizaciones

for(var ii=posi2;ii<(posi2+result_2.length);ii++){
 var campos2=result_2[ii-posi2].split('\t');
domicilios[ii]=new Object();
domicilios[ii].fecha =campos2[0];
domicilios[ii].monto =parseFloat(campos2[7].replace(',', '.'));
domicilios[ii].descripcion =campos2[6];
var fd=parseFloat(t_d.get(campos2[0]));
console.log(fd)
domicilios[ii].montod=(domicilios[ii].monto/fd).toFixed(2);
var post=campos2[6].indexOf('FACTURA')
if (post>0) {domicilios[ii].factura=campos2[6].substr(post+9,post+25)} else {domicilios[ii].factura='';}
}

for (var i=posi;i<(posi+result.length);i++){
  var campos=result[i-posi].split('\t');
  pagos[i]=new Object();
  pagos[i].fecha=campos[0];
  pagos[i].hora=campos[1];
  pagos[i].ref=campos[2];
  pagos[i].motivo=campos[6];
  pagos[i].tc=TC;
  var telfn=campos[6];
 pagos[i].telf=telfn;
//console.log(pagos[i].telf);
  var post=telfn.indexOf('CTA');
  //console.log(post + 'CTA');
  //console.log('post '+post);
  if (post>0) {pagos[i].telf=telfn.substring(post+5,post+26);}
    else {
     post=telfn.indexOf('TELF'); 
     if (post>=0) {
       pagos[i].telf=telfn.substring(post+6,post+18)
     } else
      {
       post=telfn.indexOf('CUENTA NRO'); 
       if (post>=0) {pagos[i].telf=telfn.substring(post+12,post+32);}
         else {

          post2=result[i-posi].indexOf('Abono por Creditos Directos');

post=result[i-posi].indexOf('TRANSFERENCIA RECIBIDA');

          if (post>=0 || post2>=0) { pagos[i].telf=caso_especial(telfn); }

         } 

      }
  }
 
  pagos[i].montoBs=parseFloat(campos[8].replace(',', '.'));
//  var clave=(pagos[i].telf).toString().trim();
 // pagos[i].nombre=t_c.get(clave);
 // if (pagos[i].nombre==undefined) {pagos[i].nombre=clave;}
  var clave_fecha=pagos[i].fecha.toString();
  //console.log('clave_fecha'+clave_fecha+' '+clave_fecha.length);
  pagos[i].dolar=t_d.get(clave_fecha);
  if (pagos[i].dolar!=undefined) {
   pagos[i].montodolar=(pagos[i].montoBs/pagos[i].dolar).toFixed(2);
  } else {pagos[i].montodolar=0}
}
document.getElementById("suma").innerHTML=Tipocuenta+'<br>'+Fecha_hora;;

let set= new Set( pagos.map( JSON.stringify ) )
pagos = Array.from( set ).map( JSON.parse );
posi=pagos.length;
let set2= new Set( domicilios.map( JSON.stringify ) )
domicilios = Array.from( set2 ).map( JSON.parse );
posi2=domicilios.length;


for (var j=0;j<pagos.length;j++) {
 pos[j]=0;
}
}
localStorage.setItem('domicilios_banco',JSON.stringify(domicilios));

localStorage.setItem('pagos_banco',JSON.stringify(pagos));
console.log(domicilios);
}

function borrar_datos(){
pagos=[];pos=[];domicilios=[];
localStorage.setItem('pagos_banco','');
localStorage.setItem('domicilios_banco','');
posi=0;
posi2=0;
}

function ordena_pagos(a, b) {
  if (!fecha_mayor_igual(a.fecha,b.fecha)) return -1;
  if (!fecha_mayor_igual(b.fecha,a.fecha)) return 1;
  if (a.fecha==b.fecha) {
     if (a.hora>b.hora) {return 1;} else{return -1;}
  } 

}

function ordena_pagos2(a, b) {
var  nombra=Obten_nombre(a.telf);
var  nombrb=Obten_nombre(b.telf);

  if (nombra<nombrb) return -1;
  if (nombra>nombrb) return 1;
  if (nombra==nombrb) {
  if (!fecha_mayor_igual(a.fecha,b.fecha)) return -1;
  if (!fecha_mayor_igual(b.fecha,a.fecha)) return 1;
    if (a.fecha==b.fecha) {
     if (a.hora>b.hora) {return 1;} else {return -1;}
   }
 }
}

function ordena_pagos3(a, b) {
var  nombra=Obten_nombre(a.telf);
var  nombrb=Obten_nombre(b.telf);
 if (!fecha_mayor_igual(a.fecha,b.fecha)) return -1;
  if (!fecha_mayor_igual(b.fecha,a.fecha)) return 1;
  if (a.fecha==b.fecha) {
   // console.log(a.nombre+' '+b.nombre);
    if (nombra<nombrb) return -1; 
    if (nombra<nombrb) return 1;
    if (nombra==nombrb) {
     if (a.hora>b.hora) {return 1;} else {return -1;}
   }
 }
}
function pagos_alim(){
var divaux=document.getElementById("divdata");
var texto='<table width="100%"';
 for (var i=0;i<domicilios.length;i++){
  if (domicilios[i].descripcion.indexOf('ALIMENTOS')>0) {
   texto+='<tr><td>'+'&nbsp&nbsp'+domicilios[i].fecha+'</td><td>'+'&nbsp&nbsp'+domicilios[i].monto+'</td><td>'+domicilios[i].montod+'</td></tr>';
  }
 }
texto+='</table>';
divaux.innerHTML=texto;
divaux.style.visibility="visible";
}

function pagos_cerv(){
var divaux=document.getElementById("divdata");
var texto='<table width="100%"';
 for (var i=0;i<domicilios.length;i++){
  if (domicilios[i].descripcion.indexOf('Cerveceria Polar')>0) {
   texto+='<tr><td width="20%">'+domicilios[i].fecha+'</td>';
   texto+='<td width="20%">'+'&nbsp&nbsp'+domicilios[i].factura+'</td>';
   texto+='<td width="15%">'+'&nbsp&nbsp'+domicilios[i].monto+'</td>';
   texto+='<td width="10%">'+'&nbsp&nbsp'+domicilios[i].montod+'</td></tr>';
  }
 }
texto+='</table>';
divaux.innerHTML=texto;
divaux.style.visibility="visible";

}

var textoreconocido;
function obtenerTexto(indice) {
if ( window.SpeechRecognition || window.webkitSpeechRecognition ) {
// Obtenemos el objeto de reconocimento de texto de forma compatible a diferentes navegadores
reconocimientoTexto = new ( window.SpeechRecognition || window.webkitSpeechRecognition ) ()
reconocimientoTexto.lang='es-Ve'; 
reconocimientoTexto.onerror = function(event) {
 alert("error "+event.error);
 textoreconocido="";
procesar2(indice);
}
reconocimientoTexto.onresult = function(event) {
// Mostramos el texto obtenido
textoreconocido=event.results[0][0].transcript;
console.log(textoreconocido);
procesar2(indice);
}
// Empezamos a reconocer texto
reconocimientoTexto.start();
} else {
alert ('El navegador no soporta reconocimiento de voz' );
}
}

function procesar2(ind){
var num=textoreconocido.split(" ");
var lt=num.length;
var cant='';
for (var i=0;i<lt;i++) {
 cant+=num[i];
}
console.log(cant);
if (ind==1) {divs_datos.getElementsByTagName("input")[1].value=cant;return;}
if (ind==2) {
 divs_datos.getElementsByTagName("input")[2].value=cant.substring(0,2);
 divs_datos.getElementsByTagName("input")[3].value=cant.substring(2);
return;}
 if (ind==3) {divs_datos.getElementsByTagName("input")[4].value=cant;return;}
if (ind==4) {divs_datos.getElementsByTagName("input")[5].value=cant;return;}
if (ind==5) {
 document.getElementById("nret").value=cant;
 set_n_ret();
return;}

}
function openNav() {
var texto='<a class="closebtn" onclick="closeNav()">&times;</a>';
  texto+='<a href="javascript:void(0)">About</a>';
  texto+='<a  href="javascript:void(0)" onclick="closeNav();Configurar();">Configuracion</a>';
  texto+='<a  href="javascript:void(0)" onclick="closeNav();Crea_datos();">Datos de retencion</a>';
  texto+='<a  href="javascript:void(0)" onclick="closeNav();hacerRetencion();">Hacer PDF</a>';
 document.getElementById("mySidenav").innerHTML=texto;
  document.getElementById("mySidenav").style.width = "250px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
}
//localStorage.setItem('p3',va);


/*
*/
//var divs_datos;
var contador;
const max_valor=200;
var Clientes=[];
function inicio(){
Activalector_archivos();
descarga_historico();
//contenido=localStorage.getItem('Arch_datos_banco');
var texto4=localStorage.getItem('Clientes_Pita');
var texto=localStorage.getItem('pagos_banco');
var texto2=localStorage.getItem('domicilios_banco');
var texto3=localStorage.getItem('pagos_hechos_banco');
if (texto4!='' && texto4!=null) {Clientes=JSON.parse(texto4);} else {Clientes=[];}

if ( texto3!='' && texto3!=null) {pagos_hechos=JSON.parse(texto3);} else {pagos_hechos=[];}
if ( texto2!='' && texto2!=null) {domicilios=JSON.parse(texto2);} else {domicilios=[];}
if ( texto!='' && texto!=null) {pagos=JSON.parse(texto);} else {pagos=[];}

posi=pagos.length;
posi2=domicilios.length;
//console.log(pagos);
for (var j=0;j<pagos.length;j++) {
 pos[j]=0;
}
}

function quitar(nombdiv){
var div=document.getElementById(nombdiv);
div.hidden=true;
}

function enviar_whatsapp(phone,text){
var url ='https://api.whatsapp.com/send?phone='+phone+'&text='+text;
console.log(url);
window.open(url);
}


function enviar_mail(){
var url ='mailto:brauliodeabreu@gmail.com?subject=Retenciones';
window.open(url);
}

 




function descarga_historico(){
var nomb="https://bdeabreu66.github.io/historico/historico.txt";
//var myHeaders = new Headers();
var myInit = { mode: 'cors' };
fetch(nomb,myInit)
        .then(ajaxPositiveD)
        .catch(showErrorD);

function ajaxPositiveD(response) {
      console.log('response.ok: ', response.ok);
      if(response.ok) {
        response.json().then(showResultD);
      } else {
        showErrorD('status code: ' + response.status);
      }
    }
 function showResultD(txt) {
       console.log('muestro respuesta: ', txt);
        Historico=txt;
   for (var i=0;i<Historico.length;i++) {
   t_d.set(Historico[i]["fecha"],(Historico[i]["bcv"]));
  }
  localStorage.setItem('HDOLAR',JSON.stringify(Historico));
  // procesa_contenido();
    }
function showErrorD(err) { console.log('muestor error', err); 
   Historico=JSON.parse(localStorage.getItem('HDOLAR'));
   for (var i=0;i<Historico.length;i++) {
   t_d.set(Historico[i]["fecha"],(Historico[i]["bcv"]));
  }
 procesa_contenido();
   }

}


// Registra el service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
      // Si es exitoso
      console.log('SW registrado correctamente');
    }, function(err) {
      // Si falla
      console.log('SW fallo', err);
    });
  });
}

</script>

<BODY onload="inicio();">
<!-- <div id="encabezado" style="text-align: left; border: 1px solid #999999; position: fixed;" >  -->
<!--<span style="font-size:30px;cursor:pointer; margin-left: 0px;text-align: left;" onclick="openNav()">&#9776; Menu </span>  -->
<!--</div>  -->
<div id="mySidenav" class="sidenav" ></div>

<div id="divdata"></div>
<div id="menu">
<span style="display:block;font-size:2em;color:red;" id="suma">Prueba</span>
<table width="100%" ><tr>
<td  style="font-size:0.5em;width:20;"><button class="btop" onclick="genera_salida1();">Fecha</button></td>
<td style="font-size:0.5em;width:20;"><button class="btop" onclick="genera_salida2();">Cliente</button></td>
<td style="font-size:0.5em;width:20;"><button class="btop" onclick="genera_salida3();">Fecha-Cliente</button></td>
<td style="font-size:0.5em;width:20;"><button class="btop" onclick="pagos_alim();">Pagos-Alim</button></td>
<td style="font-size:0.5em;width:20;"><button class="btop" onclick="pagos_cerv();">Pagos-Cerv</button></td>

</tr></table>
</div>
<div id="header"> 
<button class="btop" onclick="Activalector_archivos();">Cargar Datos V4</button>  
<button class="btop" onclick="borrar_datos();">Borrar Datos</button>

</div>

<div>
<label hidden id=selected>Nothing selected</label><br>
<input hidden type=file id="choose2" accept="*.txt" multiple>
</div>
<div id="div3">
</div>
<div id="div4">
</div>
</body>
</html>
