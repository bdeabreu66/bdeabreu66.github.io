<HTML>
<HEAD>
<TITLE>  Facturacion Polar</TITLE>
<!-- <link rel="stylesheet" href="styles.css" > -->
<link rel="manifest" href="manifest.json"> 

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
<style>

body{
font-size:30px;
}
input[type=number]{
width: 3em;
}


.btop{
font-size:0.6em;
}

.bot3:hover {
  background-color: SteelBlue; /* Green */
  color: blue;
}
.bot3{
transition-duration: 0.4s;
background-color: SkyBlue; /* Green */
padding:15px;
font-size:1.5em;
width:70%;
}

.bot4:hover {
  background-color: SteelBlue; /* Green */
  color: white;
}
.bot4{
background-color: PowderBlue; /* Green */
transition-duration: 0.4s;
padding:15px;
font-size:1.0em;
width:70%;
}
.btn2{
font-size:1em;
}


#dsearch {
position:relative;
}

#enc {
position:relative;
}
.nav {
font-size:2em;

}
#divt {
top:35%;
left:0%;
height: 60%;
text-align:center;
width:95%;
overflow-y:auto;
}

#auxiliar {
position:fixed;
background-color:green;
top:30%;
left:0%;
height: 40%;
width:98%;
overflow-y:scroll;
}

input[type=text]{
font-size:0.8em;
width: 4em;
border: 2px solid red;
border-radius: 4px;
padding: 4px 4px;
  margin: 4px 0;
  box-sizing: border-box;
  background-color: #3CBC8D;
  color: white;
}

input[type=text]:focus {
  background-color: lightblue;
}

p{
font-size:1.5rem;
background-color:black;
color:white;
padding:0px;
margin:0px;

}
td{
font-size:1.5rem;
padding:1px;
}
table{
margin:0px;
padding:0px;

}

#cat {
position:fixed;
top:35%;
left:0px;
height: 60%;
font-size:1.5rem;
text-align:center;
width:95%;
overflow-y:scroll;
}

#introd {
position:fixed;
background-color:Aqua;
border-radius: 5% 5%;
top:30%;
left:0%;
height: 40%;
width:98%;
overflow-y:scroll;
}


#footer {
  display: none;
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  background-color: blue;
  color: white;
  text-align: center;
  font-size:0.5em;
}
#voz {
  display: block;
  position: fixed; 
  left: 0;
  bottom: 0;
  width: 100%;
  background-color: white;
  color: white;
  text-align: center;
  font-size:0.5em;
  
}

#header {
  position: fixed;
  left: 0;
  top: 0;
  height=5%;
  width: 100%;
  background-color: blue;
  color: white;
  text-align: center;
  font-size:0.5em;
}

#cliente {
  position: fixed;
  left: 0;
  top: 5%;
  height:80%;
   width: 100%;
  background-color: Turquoise;
  color: red;
  text-align: left;
  font-size:0.8em;
}

.dolar {
 // position: fixed;
 // left: 0;
 // top: 50px;
  width: 100%;
  }
.cont0{
}
.cont1 {
display:grid;
grid-template-columns: 20% 60% 20%;
border-bottom:1px solid black;
}

.conth1 {
grid-columns: 1/2;
}
.conth2 {
grid-columns: 2/3;
}
.conth3 {
grid-columns: 3/4;
}

.micro {
   background-image:url(microphone.svg);
   width:30px;
	height:30px;
	font-size:16px;
	padding:0px 0px 0px 0px;
	background-size:30px 30px;
	background-position:-2px 0px;
    fill: green;

border-radius: 8px;
}
</style>

</HEAD>


<BODY onload="carga();" onunload="salir();">

<br>

<div class="dolar">
<!-- <table width="100%"> -->
<!-- <tr><td>Paralelo </td><td><input id="t1" type="text" value="0"></td> -->
<!-- <tr><td>BCV </td><td><input id="t2" type="text" value="0"></td></tr> -->
<!-- <div id="menu"></div> -->
<!-- <tr><td><input id="t3" onchange="camb();" type="checkbox" value="Automatico"><label for="t3"> Automatico </label></td></tr> -->
<!-- </table> -->
</div>
<div class="cont0">
<div class="cont1">
<div class="con1h1">
<center>BCV: <input id="t2" type="text" value="0"></center>
</div>
<div class="con1h2">
<center>Facturaci&oacute;n <br><span id="fecha_p" style="font-size:0.8em;"></span></center>
</div>
<div class="con1h3">
<button class="nav" onclick="sube_cat()";>&#8630;</button>
</div>
</div>
</div>
<div id="arbol" style="font-size:0.4em;"></div>
<div id="cat" ></div>
<!-- <div id="dsearch"> <input id="search" type="text" placeholder="Buscar" oninput="refresca();"></div>-->
<div id="divt" ></div>
<div id="introd" ></div>
<div id="content" hidden="false"></div>
<div id="factura" hidden="true"></div>
 <div id="footer"> Dr. Braulio De Abreu. email: brauliodeabreu@gmail.com <br> Tlfs: +58414 4728631 +58412 8552592</div>
<!-- <div id="voz"> <button class="micro" onclick="obtenerTexto();"></button> </div> -->
 <div id="voz"> <table width="50%"><tr><td width="20%" >Suma:</td><td width="20%" id="suma"></td><td width="5%" <button onclick="borra_suma();">B</button></td></tr></table> </div>
<div id="header">
<table width="100%">
<tr align="center">
<td width="12%"> <button class="btop" onclick="Mantenimiento();">Mant</button></td>
<td width="12%"> <button class="btop" onclick="Actualiza_cliente();">Cli</button></td>
<td width="12%"><button class="btop" onclick="descarga_historico();">Dolar</button></td>
<td width="12%"><button class="btop" onclick="factura();">Fact</button></td> 
<td width="12%"><button class="btop" onclick="total();">Ventas</button></td>
<td width="12%"><button class="btop" onclick="desp_inventario();">Inv</button></td>
</tr></table>
</div>

<div id="cliente" hidden="true">
<span onclick="limpiaCliente();">Cliente:</span> <input style="width:45%;" type="text" id="cli" value="" list="listaclientes" oninput="datos_cliente();">&nbsp&nbsp<button onclick="setcliente();">OK</button>&nbsp&nbsp<button onclick="elimina_cliente();">E</button>&nbsp&nbsp<button onclick="salir_cliente();">X</button>'
<datalist id="listaclientes"></datalist><br>
Direcci&oacute;n:<textarea style="width:55%;" type="text" id="dircli" value="" ></textarea><br>
Rif:<input style="width:55%;" type="text" id="rifcli" value="" ><br>
Tlf:<input style="width:55%;" type="text" id="tlfcli" value="" ><br>
AR:<input style="width:55%;" type="checkbox" id="espcli" value="" ><br>
Deuda:<input style="width:55%;" type="text" id="deucli" value="" ><br>
Monto ult. Fac:<input style="width:55%;" type="text" id="ultfac" value="" ><br>
Vacios polar:<input style="width:55%;" type="text" id="vaccli" value="" ><br>
Vacios 350 ml:<input style="width:55%;" type="text" id="vacclir1" value="" ><br>
Vacios 1.25 L:<input style="width:55%;" type="text" id="vacclir2" value="" ><br>
</div>

<div>
<label hidden id=selected>Nothing selected</label><br>
<input hidden type=file id="choose" accept="*.txt" >
</div>
<div id="lista" > </div>
<!--   -->
<div id="auxiliar" hidden="true"></div>
<script src="arbol.js" type="text/javascript"></script>
<script type="text/javascript" src="FileSaver.js"></script>
<script type="text/javascript" src="selectFile.js"></script>
<script type="text/javascript">

var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
var SpeechGrammarList = SpeechGrammarList || window.webkitSpeechGrammarList
var SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent
var recognition;
function set_var_voz(){
var producto='';
m=0;
for(var i=0;i<data.length;i++){
 if (data[i][11]!='' &&  data[i][8]!=0) 
  { if (m==0) {producto+=data[i][11];m=1} else {producto+='|'+data[i][11]} }
 }

var selector='unidades|cajas|bultos|unidad|caja|bulto';
var cantidad='un|una';
for(var i=1;i<301;i++){
 cantidad+='|'+i;
}
console.log(cantidad);
//var grammar = '#JSGF V1.0; grammar statement; <statement>=<cantidad> <selector> de <producto>;public <producto> = ' + producto + ' ;'+'public <selector> = ' + selector + ' ;'+'public <cantidad> = ' + cantidad + ' ;'
var grammar = '#JSGF V1.0; grammar producto; public <producto> = ' + producto + ';';
recognition = new SpeechRecognition();
var speechRecognitionList = new SpeechGrammarList();
console.log(grammar);

speechRecognitionList.addFromString(grammar, 1);
recognition.grammars = speechRecognitionList;
recognition.continuous = false;
recognition.lang = 'es-US';
recognition.interimResults = false;
recognition.maxAlternatives = 1;
recognition.onresult = function(event) {
  var resultado = event.results[0][0].transcript;
 // diagnostic.textContent = 'Result received: ' + color + '.';
 // bg.style.backgroundColor = color;
 console.log('Confidence: ' + event.results[0][0].confidence);
 alert(resultado);//console.log(resultado);
}
}


function obtenerTexto() {
/*if ( window.SpeechRecognition || window.webkitSpeechRecognition ) {
// Obtenemos el objeto de reconocimento de texto de forma compatible a diferentes navegadores
reconocimientoTexto = new ( window.SpeechRecognition || window.webkitSpeechRecognition ) ()
reconocimientoTexto.lang='es-Ve'; 
reconocimientoTexto.onerror = function(event) {
 alert("error "+event.error);
 textoreconocido="";
//procesar2(indice);
}
reconocimientoTexto.onresult = function(event) {
// Mostramos el texto obtenido
textoreconocido=event.results[0][0].transcript;
alert(textoreconocido);
//procesar2(indice);
}
// Empezamos a reconocer texto
reconocimientoTexto.start();
} else {
alert ('El navegador no soporta reconocimiento de voz' );
}
*/
 recognition.start();
}

function leer_ventas_diarias(fecha){
//=localStorage,getItem(fecha)

}

function guarda_facturas_IDB(){
let openReq = indexedDB.open('DIST_PITA',1);
openRequest.onupgradeneeded = function () {
  // triggers if the client does not have a database
  // initialization
};
openRequest.onerror = function () {
  console.error("Error", openRequest.error);
};
openRequest.onsuccess = function () {
  let db = openRequest.result;
  db.createObjectStore("FACTURAS");

  // continue working with the database using the db object
};
}




function guarda_clientes_IDB(){

}
function lee_facturas_IDB(){

}
function lee_clientes_IDB(){

}

function importar(){
getFile = new selectFile;
getFile.targets('choose','selected');
archivos=document.getElementById('choose');
archivos.value=null;
archivos.addEventListener('change', Leer_Archivo, false);
getFile.simulate();
}

function importar2(){
getFile = new selectFile;
getFile.targets('choose','selected');
archivos=document.getElementById('choose');
archivos.value=null;
archivos.addEventListener('change', Leer_Archivo2, false);
getFile.simulate();
}

function Leer_Archivo(e){
 var archivos=e.currentTarget.files;

  var lector=new FileReader();
  lector.addEventListener("load",(e) => {
    datos_imp = e.target.result;
    var data_sep=datos_imp.split('*#*');

if (data_sep[2]=='Clientes_Pita') {
if (data_sep[3]!=null) {
localStorage.setItem('Clientes_Pita',data_sep[3]);
}
//guarda_clientes_IDB()
}

if (data_sep[4]=='Inventario_PO') {
localStorage.setItem(data_sep[4],data_sep[5]);
}

if (data_sep[0]=='FACTURAS') {
localStorage.setItem(data_sep[0],data_sep[1]);
facturas=JSON.parse(data_sep[1]);
//guarda_facturas_IDB()
}

//    alert(datos_imp.length);
  });
  lector.readAsText(archivos[0]);
}

function Leer_Archivo2(e){
 var archivos=e.currentTarget.files;
 //alert(archivos);
  var lector=new FileReader();
  lector.addEventListener("load",(e) => {
    datos_imp = e.target.result;
    var data_sep=datos_imp.split('*#*');
    var n=Math.trunc(data_sep.length/2);
    for (var i=0;i<n;i++) {
 // if (localStorage.getItem(data_sep[2*i])===null) {
    localStorage.setItem(data_sep[2*i],data_sep[2*i+1]);
//  }
  }
  });
  lector.readAsText(archivos[0]);
}

function permuta(o){
var propi=o.getAttribute('pos')
if (propi=="0") {o.setAttribute("pos", "1");o.style.color='white';suma+=parseFloat(o.innerText)} 
 else 
{o.setAttribute("pos", "0");o.style.color='black';suma-=parseFloat(o.innerText)}

document.getElementById('suma').innerText=suma.toFixed(2);
}

function Respalda_inventario(){
var info='';
for (var i=0;i<inventario.length;i++){
var ind=clave_ind.get(inventario[i]["CLAVE"]);
info+=inventario[i].CLAVE+ ' '+ data[ind][0]+' '+inventario[i].CAJAS+' Cajas'+ inventario[i].UNID+' Unid'+'\r\n';
}
let hoy=new Date();

narch="Inventario_ "+hoy.toLocaleString()+'.txt';
 var blob = new Blob([info], {type: "text/plain;charset=utf-8"});
 saveAs(blob,narch);
}
function exportar(){
 var data='';
 var sep='*#*';

data="FACTURAS"+sep+JSON.stringify(facturas);

data+=sep+'Clientes_Pita'+sep+localStorage.getItem('Clientes_Pita');
//data+=sep+'Clientes_Pita'+sep+JSON.stringify(Lclientes);
data+=sep+'Inventario_PO'+sep+localStorage.getItem('Inventario_PO');

let hoy=new Date();
let narch='facturas '+hoy.toLocaleString()+'.txt'
 var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
 saveAs(blob,narch);
}
function fecha_mayor_igual(f1,f2){
var a2=f2.split('/');
var a1=f1.split('/');
 if (a2[2]>a1[2] || (a2[2]==a1[2] && a2[1]>a1[1]) || (a2[2]==a1[2] && a2[1]==a1[1]) && a2[0]>a1[0]) {return false; } else {return true;}
}
var totalunid=[];
var totalcajas=[];
var modo_inv=false;

function borra_suma(){
suma=0;
 document.getElementById('suma').innerText=suma.toFixed(2);
document.getElementById("suma").innerText="0";
var tds=document.getElementsByClassName("pagocli");
for (var i=0;i<tds.length;i++){
tds[i].setAttribute("pos", "0");
tds[i].style.color='black';
}

}
function muestra_total_ventas(){
var nd=data.length;
var texto='';
var div3 = document.getElementById("lista");
div3.style="position: fixed;top :7%; left: 0px; width: 100%;height:80%;background-color:lightgray;color:white; text-align: left; border: 3px solid #73AD21;";
texto+='<div style="position: fixed; text-align:right;background-color: gray;width:100%;">';
texto+='<table width="100%"><tr><td style="width:55%;text-align:center;color:blue;" >Productos vendidos</td><td width="5%"><button  title="Salir" onclick="quitarlista();" > x </button></td></tr></table></div><br>';
texto+='<div style="overflow:auto;height:90%;">';
texto+='<table style="width:100%;">';
//texto+='<br>';
for(var i=0;i<nd;i++){
 if (totalcajas[i]!=0 ||totalunid[i]!=0 ) {
//console.log(data[i][0]+" "+totalcajas[i]+ " cajas");
var tot=totalcajas[i]*data[i][1]+totalunid[i];
var ncaj=Math.floor(tot/data[i][1]);
var nunid=tot % data[i][1];
texto+='<tr><td style="width:80%;font-size:1em;"  >'+data[i][0]+'</td><td style="width:10%;font-size:1em;" class="pagocli" pos="0" onclick="permuta(this)">'+ncaj+' C</td><td style="width:10%;font-size:1em;">'+nunid+' U</td>'+'</tr>';
}

}
texto+='</table></div>';
texto+='<p>Monto: '+Monto.toFixed(2)+ ' $ Ganancia:'+(Ganancia).toFixed(2)+'</p>';
div3.innerHTML=texto;
}

function fecha_mayor_igual(f1,f2){
var a2=f2.split('/');
var a1=f1.split('/');
 if (a2[2]>a1[2] || (a2[2]==a1[2] && a2[1]>a1[1]) || (a2[2]==a1[2] && a2[1]==a1[1]) && a2[0]>a1[0]) {return false; } else {return true;}
}

function inv_fecha_date(f){
var comp=f.split('-');
var sal=comp[2]+'/'+comp[1]+'/'+comp[0];
//console.log('sal2 '+sal);
return sal;
}

function fecha_date(f){
var comp=f.split('/');
var sal=comp[2]+'-'+comp[1]+'-'+comp[0];
//console.log('sal '+sal)
return sal;
}

function fecha_estandar(f){
  var year=f.getFullYear();
  var mes=f.getMonth();mes++;if (mes<10) {mes='0'+mes}
  var day=f.getDate();if (day<10) {day='0'+day}
return day+'/'+mes+'/'+year;
}

function Mantenimiento(){
var div3 = document.getElementById("lista");
div3.style="display:block ;position: fixed;top :30px; left: 0px; width: 100%;height:40%;background-color: blue;color:white; text-align: left; border: 3px solid #73AD21;";
var texto='';
texto+='<div> <table style="text-align:center;margin:auto;">';
texto+='<tr><td><button onclick=importar()>Importar Facturas</button></td></tr>';
//texto+='<tr><td><button onclick=importar2()>Importar Facturas (FAC_)</button></td></tr>';
texto+='<tr><td><button onclick=exportar()>Exportar Facturas</button></td></tr>';
//texto+='<tr><td><button onclick=convertir()>Convertir Facturas</button></td></tr>';
//texto+='<tr><td><button onclick=elim_FAC()>Eliminar FACS</button></td></tr>';
texto+='<tr><td><button onclick=quitar_div("lista");>Salir</button></td></tr>';
texto+='</table></div>';
div3.innerHTML=texto;

}
function elim_FAC(){
for(var i=0;i<localStorage.length;i++){
    var nomb=localStorage.key(i); 
    var parte=nomb.split("_");
    if (nomb.indexOf("FAC_")==0) {
     localStorage.removeItem(nomb);
 }
}
}

function convertir(){
facturas=[];
var nf=0;
var indice=0;
for(var i=0;i<localStorage.length;i++){
    var nomb=localStorage.key(i); 
    var parte=nomb.split("_");
    if (nomb.indexOf("FAC_")==0) {
      var nombf=parte[1]+"_"+parte[2]+"_"+parte[3];
       var info=localStorage.getItem(nomb);
       facturas[indice]=new Object();
       facturas[indice].cliente=parte[1];
       facturas[indice].fecha=parte[2];
       facturas[indice].nro=parte[3];
       info_s=info.split("&")
       facturas[indice].bcv=info_s[0];
       monto_factura2(nombf);
       facturas[indice].total=total_factura.toFixed(2);
       facturas[indice].ganancia=Gdolar.toFixed(2);
       facturas[indice].total_ret=MONTOF.toFixed(2);
       facturas[indice].items=[];
       var total_f=0;
       
       for (var j=1;j<info_s.length;j++) {
         var prod=info_s[j].split('#');
         var ind=clave_ind.get(prod[0]);
         facturas[indice].items[j-1]=new Object();
         facturas[indice].items[j-1].cod=prod[0];
         facturas[indice].items[j-1].cu=prod[1];
         facturas[indice].items[j-1].pu=prod[2];
         facturas[indice].items[j-1].cb=prod[3];
         facturas[indice].items[j-1].pb=prod[4]; 
         //total_f+=parseInt(prod[1])*prod[2];
       }
   
    console.log('factura '+indice);
    console.log(facturas[indice]);
   indice++;
   } 
} 

localStorage.setItem("FACTURAS",JSON.stringify(facturas));
//guarda_facturas_IDB();
}

function quitar_div(div_b){
document.getElementById(div_b).style.visibility='hidden';
}
var facturas=[];

function total(){
var textoT="";
var div3 = document.getElementById("lista");
div3.style="position: fixed;top :0px; left: 0px; width: 100%;height:40%;background-color: black;color:white; text-align: left; border: 3px solid #73AD21;";

textoT+='Desde: <input id="f1" type="date" value="'+fecha_date(fecha_actual())+'"><br>';
textoT+='Hasta: <input id="f2" type="date" value="'+fecha_date(fecha_actual())+'"><br><br>';
textoT+='<span onclick="limpiaCliente2();">Cliente:</span>';
textoT+='<input style="width:30%;" type="text" id="cli2" value="" list="listaclientes">';
textoT+='<datalist id="listaclientes"></datalist>';
textoT+='<br><button onclick="quitarlista();" >Cancelar </button>&nbsp&nbsp&nbsp<button onclick="total_unidades_vendidas();" >Ok </button>';
div3.innerHTML=textoT;
}
var Monto=0;
var Ganancia=0;

function total_unidades_vendidas(){
Monto=0;
Costo=0;
var f1=document.getElementById("f1").value;
var f2=document.getElementById("f2").value;
var clib=document.getElementById("cli2").value;
f1=inv_fecha_date(f1);
f2=inv_fecha_date(f2);
quitarlista();
//console.log('rango de fechas'+f1+' '+f2);
Ganancia=0;
var nd=data.length;
//console.log(nd);
for(var i=0;i<nd;i++){
 totalunid[i]=0;
 totalcajas[i]=0;
}
var fecha=fecha_actual();
//console.log(fecha);
for(var i=0;i<facturas.length;i++){
  var fech=facturas[i].fecha;
  var nombcli=facturas[i].cliente;
  if ( (fecha_mayor_igual(fech,f1)) && (fecha_mayor_igual(f2,fech)) && ( ((nombcli.indexOf(clib)==0) && clib!='' ) || (clib=='' && nombcli.indexOf('Pedido')!=0 ) ) ) {
    for (var j=0;j<facturas[i].items.length;j++) {
      var ind=clave_ind.get(facturas[i].items[j].cod);
      totalunid[ind]+=parseInt(facturas[i].items[j].cu);
      totalcajas[ind]+=parseInt(facturas[i].items[j].cb);
    }//for j
      if (facturas[i].cliente.indexOf('Pita')==-1 && facturas[i].cliente.indexOf('Obsequio')==-1 ) {Ganancia+=parseFloat(facturas[i].ganancia);}
      if (facturas[i].cliente.indexOf('Obsequio')==-1 ) 
         {Monto+=parseFloat(facturas[i].total);}
  } //if
} // for
 muestra_total_ventas();
} // fun

inventario=[];

function carga_inventario(){
var invent=localStorage.getItem('Inventario_PO');
if (invent!=null) {
 var items=invent.split('&');
  for (var i=0;i<items.length;i++){
   //console.log(items[i]);
   var partes=items[i].split('#');
    ind=inventario.findIndex(element => element.CLAVE==partes[0])
   inventario[ind]={"CLAVE":partes[0],"UNID":partes[1],"CAJAS":partes[2]};
  }
}
//console.log(inventario);
}
function desp_inventario(){
let pu=0;
let pb=0;
let fiva=1;
texto='';
TOTAL_INVENTARIO=0;
carga_inventario();
var div3 = document.getElementById("lista");
div3.style="position: fixed;top :7%; left: 0%; width: 100%;height:80%;background-color:lightgray;color:white; text-align: left; border: 3px solid #73AD21;";
texto+='<div style="position: fixed;top :7%; text-align:right;background-color: gray;width:100%;">';
texto+='<table width="100%"><tr><td style="width:70%;text-align:center;color:blue;" >Inventario</td>';
texto+='<td width="10%"><button  title="Respalda" onclick="Respalda_inventario();" > R </button></td>';
//texto+='<td width="10%"><button  title="Borra" onclick="anula_inventario();" > B </button></td>';
texto+='<td width="10%"><button  title="Salir" onclick="quitarlista();" > x </button></td></tr></table></div><br>';
texto+='<div style="overflow:auto;height:90%;">';
texto+='<table style="width:100%;">';
for(var i=0;i<inventario.length;i++){
//console.log('clave '+inventario[i]["CLAVE"]);
 var ind=clave_ind.get(inventario[i]["CLAVE"]);
 //console.log('indice '+ind);
// if (inventario[i]["UNID"]!=0 || inventario[i]["CAJAS"]!=0 ) {
 if (data[ind][8]!=0) {
   var nuc=parseInt(data[ind][1]);
  var tu=parseInt(inventario[i]["CAJAS"])*nuc+parseInt(inventario[i]["UNID"]);
   var tc=Math.floor(tu/nuc);
  [pu,pb]=precio(ind);
  var ru=tu % nuc;
  if (data[ind][3]==0) {fiva=1} else {fiva=1.16}
  if (tc>0) {TOTAL_INVENTARIO+=parseFloat(tc*pb*fiva);}
  if (ru>0) {TOTAL_INVENTARIO+=parseFloat(tc*pb*fiva);}

  texto+='<tr><td style="width:70%;font-size:1em;">'+data[ind][0]+'</td>';
  texto+='<td style="width:15%;font-size:1em;" class="pagocli" pos="0" onclick="permuta(this)">'+tc+' C</td>';
  texto+='<td style="width:15%;font-size:1em;">'+ru+' U</td>';
  } 
 
}
texto+='</tr></table></div>';
texto+='<p> TOTAL: '+ TOTAL_INVENTARIO.toFixed(2) + '</p>';
div3.innerHTML=texto;
}


function guarda_inventario(){
var texto="";
  for (var i=0;i<inventario.length;i++){
      texto+='&'+inventario[i]["CLAVE"]+'#'+inventario[i]["UNID"]+'#'+inventario[i]["CAJAS"];
  }
if (texto.length>0) {localStorage.setItem('Inventario_PO',texto.substr(1));} else {localStorage.setItem('Inventario_PO','');}
}

function anula_inventario(){
const resp = confirm("Esta seguro de eliminar el inventario");

if (resp) {
  inventario=[]; 
  guarda_inventario();
  desp_inventario();
}
}
function restar_inventario(){
 resp=confirm('Desea quitar del inventario');
if (resp) { resta_inventario();}
}


function resta_inventario(){

  for (var i=0;i<data.length;i++){
   if (data[i][4]!=0 || data[i][5]!=0) {
       ind=inventario.findIndex(element => element.CLAVE==data[i][9])
       if (ind==-1) {ind=inventario.length;
         inventario[ind]["CLAVE"]=data[i][9];
         inventario[ind]["UNID"]=0;
         inventario[ind]["CAJAS"]=0;
       }
 inventario[ind]["UNID"]=(parseInt(inventario[ind]["UNID"])-data[i][4]).toString();
 inventario[ind]["CAJAS"]=(parseInt(inventario[ind]["CAJAS"])-data[i][5]).toString();
     }
 }
guarda_inventario();

}

function inicio_inventario(){
 for (var i=0;i<data.length;i++){
    inventario[i]={"CLAVE":data[i][9],"UNID":"0","CAJAS":"0"}
}
//console.log(inventario);
carga_inventario();

//console.log(inventario);
}

function suma_inventario(){
const resp = confirm("Esta seguro de agregar al Inventario");
if (resp) {
  for (var i=0;i<data.length;i++){
      if (data[i][4]!=0 || data[i][5]!=0) {
       ind=inventario.findIndex(element => element.CLAVE==data[i][9])
  if (ind==-1) {ind=inventario.length;
    alert(ind);
    alert(data[i][9]);
alert(inventario[0]);
    inventario[ind]["CLAVE"]=data[i][9];
    inventario[ind]["UNID"]=0;
    inventario[ind]["CAJAS"]=0;
 }
       inventario[ind]["UNID"]=(parseInt(inventario[ind]["UNID"])+parseInt(data[i][4])).toString();
       inventario[ind]["CAJAS"]=(parseInt(inventario[ind]["CAJAS"])+parseInt(data[i][5])).toString();
      }
 }
//console.log(inventario);
guarda_inventario();
}
}
var suma=0;
function suma_inventario2(){
  for (var i=0;i<datfac.length;i++){
      if (datfac[i].unidad!=0 || datfac[i].cajas!=0) {
       ind=inventario.findIndex(element => element.CLAVE==data[i][9])
      if (ind==-1) {ind=inventario.length;
        inventario[ind]["CLAVE"]=data[i][9];
        inventario[ind]["UNID"]=0;
        inventario[ind]["CAJAS"]=0;
 }
       inventario[ind]["UNID"]=(parseInt(inventario[ind]["UNID"])+parseInt(datfac[i].unidad)).toString();
       inventario[ind]["CAJAS"]=(parseInt(inventario[ind]["CAJAS"])+parseInt(datfac[i].cajas)).toString();
      }
 }
//console.log(inventario);
guarda_inventario();
}
function ventas_periodo(fecha1,fecha2){
}

var cliente='';
var AClientes=[];

function limpiaCliente2(){
document.getElementById("cli2").value='';
}

function limpiaCliente(){
document.getElementById("cli").value='';
datos_cliente();
}

function elimina_cliente(){
var ecliente;
document.getElementById("cliente").hidden=true;
ecliente=document.getElementById("cli").value;
var pos=AClientes.findIndex(x=>x.nombre===ecliente);
//console.log(pos);
const resp = confirm("Esta seguro de eliminar el cliente");
if (pos>=0 && resp) {AClientes.splice(pos,1);guarda_clientes();
   limpiaCliente();
 }
//console.log('LC: '+Lclientes);
}
function salir_cliente(){
document.getElementById("cliente").hidden=true;

}

function setcliente(){
var indic;
cliente=document.getElementById("cli").value;
if (cliente!='') {
  direccion=document.getElementById("dircli").value;
  telefono=document.getElementById("tlfcli").value;
  rifcliente=document.getElementById("rifcli").value;
  cliente_especial=document.getElementById("espcli").checked;
  deuda_cliente=document.getElementById("deucli").value;
  ult_cliente=document.getElementById("ultfac").value;
  vacio_cliente=document.getElementById("vaccli").value;
  vacio_cliente1=document.getElementById("vacclir1").value;
  vacio_cliente2=document.getElementById("vacclir2").value;

  indic=-1;
  if (AClientes.length>0) {indic=AClientes.findIndex(x => x.nombre == cliente);} 
  Ocliente=new Object();
  Ocliente.nombre=cliente;
  Ocliente.dir=direccion;
  Ocliente.tlf=telefono;
  Ocliente.rif=rifcliente;
  Ocliente.esp=cliente_especial;
  Ocliente.deuda=deuda_cliente;
  Ocliente.ultfac=ult_cliente;
  Ocliente.vacio=vacio_cliente;
  Ocliente.vacio1=vacio_cliente1;
  Ocliente.vacio2=vacio_cliente2;

  if (indic==-1) {AClientes.push(Ocliente); } else {Object.assign(AClientes[indic],Ocliente)}
  guarda_clientes();
 }
  document.getElementById("cliente").hidden=true;
  if (document.getElementById("factura").hidden==false) {factura2();}
}

var Ocliente=new Object();

function Actualiza_cliente(){
Lee_clientes();
divcliente=document.getElementById("cliente");
//divcliente.innerHTML=texto;
divcliente.hidden=false;
datos_cliente();
}

function datos_cliente(){
cliente=document.getElementById("cli").value;
var ind=AClientes.findIndex(x=>x.nombre==cliente);
//alert('datos '+ ind);
if (ind>=0) {
// alert(AClientes[ind].deuda);
 //Object.assign(Ocliente,AClientes[ind]);
 document.getElementById("rifcli").value=AClientes[ind].rif;
 document.getElementById("tlfcli").value=AClientes[ind].tlf;
 document.getElementById("espcli").checked=AClientes[ind].esp;
 document.getElementById("dircli").value=AClientes[ind].dir;
 document.getElementById("deucli").value=AClientes[ind].deuda;
 document.getElementById("ultfac").value=AClientes[ind].ultfac;
 document.getElementById("vaccli").value=AClientes[ind].vacio;
 document.getElementById("vacclir1").value=AClientes[ind].vacio1;
 document.getElementById("vacclir2").value=AClientes[ind].vacio2;

} else {

 document.getElementById("rifcli").value='';
 document.getElementById("espcli").checked=false;
 document.getElementById("dircli").value='';
 document.getElementById("deucli").value=0;
 document.getElementById("tlfcli").value='';
}
}
function guarda_clientes(){
var Lclientes='';

if (AClientes.length>0) {
 localStorage.setItem('Clientes_Pita',JSON.stringify(AClientes));
// guarda_clientes_IDB();
}
   else 
{
localStorage.setItem('Clientes_Pita','');
// guarda_clientes_IDB();
}

}

function Lee_clientes(){
Lclientes=localStorage.getItem('Clientes_Pita');
//lee_clientes_IDB();
if (Lclientes!=null) { AClientes=JSON.parse(Lclientes);} else {AClientes=[];}

//console.log(AClientes);
if (AClientes.length>0) {
 var options='';
 for (var i = 0; i < AClientes.length; i++) {
   options += '<option value="' + AClientes[i]["nombre"] + '" />';
 }
//console.log('op'+options)

document.getElementById('listaclientes').innerHTML = options;
} else {AClientes=[];}
cliente=localStorage.getItem('Cliente');
var indcliente=AClientes.findIndex(x=>x.name===cliente);
}

function guarda_pedido(){
var texto='';
for (var i=0;i<data.length;i++) {
if ((data[i][4]!=0) || (data[i][5]!=0)) { 
 texto+='&'+data[i][9]+'#'+data[i][4]+'#'+data[i][5];
}
if (texto.length>2) {localStorage.setItem('Pedido',texto.substr(1));} else {localStorage.setItem('Pedido','');}
} 
localStorage.setItem('Cliente',cliente);
//guarda_clientes_IDB();
}

function crea_lista_facturas(){
listasel=[];


var lf=facturas.length;

for(var i=0;i<lf;i++){
  listasel.unshift(facturas[i].cliente+'_'+facturas[i].fecha+'_'+facturas[i].nro);
 } 
listasel.sort();
console.log(listasel);
}

function lee_facturas(){
crea_lista_facturas();
//selectlista(0);
}

function ord_nomb(a,b){
var ela=a.split('_');
var elb=b.split('_');
 if (ela[0]<elb[0]) return -1;
  if (ela[0]>elb[0]) return 1;
  if (!fecha_mayor_igual(ela[1],elb[1])) return -1;
  if (!fecha_mayor_igual(elb[1],ela[1])) return 1;

 return 0;
}
function ord_fecha(a,b){
var ela=a.split('_');
var elb=b.split('_');
  if (!fecha_mayor_igual(ela[1],elb[1])) return 1;
  if (!fecha_mayor_igual(elb[1],ela[1])) return -1;
  if (ela[0]<elb[0]) return -1;
  if (ela[0]>elb[0]) return 1;
  return 0;
}

function ordena_nombre(){
crea_lista_facturas();
listasel=listasel.sort(ord_nomb);
selectlista(0);
}

function ordena_fecha(){
crea_lista_facturas();
listasel=listasel.sort(ord_fecha);
selectlista(0);
}
function ordena_cliente(){
crea_lista_facturas();
listasel=listasel.filter(x=>x.split('_')[0]==cliente);
listasel=listasel.sort(ord_fecha);
selectlista(1);
}
var total_factura=0;

function selectlista(t){
var textoT="";
var div3 = document.getElementById("lista");
div3.style="position: fixed;top :0px; left: 0px; width: 100%;height:80%;background-color: lightgray;color:white; text-align: left; border: 3px solid #73AD21;";
textoT+='<div style="position: fixed; text-align:right;background-color: gray;width:100%;">';
textoT+='<table width="100%"><tr>';
textoT+='<td style="width:60%;text-align:center;color:blue;" >Facturas anteriores</td>';
textoT+='<td width="10%"><button  title="Nombre" onclick="ordena_cliente();" > C </button></td>';
textoT+='<td width="10%"><button  title="Nombre" onclick="ordena_nombre();" > N </button></td>';
textoT+='<td width="10%"><button  title="Fecha" onclick="ordena_fecha();" > F </button></td>';
textoT+='<td width="10%"><button  title="Salir" onclick="quitarlista();" > x </button></td>';
textoT+='</tr></table></div><br>';
textoT+='<div style="overflow:auto;height:90%;font-size:0.6rem;">';
textoT+='<table style="width:"100%;font-size:0.2rem;">';
console.log(textoT);
for (var i=0;i<listasel.length;i++) {
partes=listasel[i].split('_');

if (t=="0") {
textoT+='<tr style="cursor:pointer;" onclick="clickp('+i+')";>';
textoT+='<td style="width:40%;color:white;background:DodgerBlue;" >'+partes[0]+'</td>';
textoT+='<td style="width:10%;color:white;background:DodgerBlue;" >'+partes[1]+'</td>';
textoT+='<td style="width:10%;color:white;background:DodgerBlue;" >'+partes[2]+'</td></tr>'; 

console.log('<tr style="cursor:pointer;" onclick="clickp('+i+')";><td style="width:80%;color:white;background:DodgerBlue;" >'+partes[0]+'</td>+ '+partes[1]+'</td><td style="width:20%;"></td></tr>');
} else {
 textoT+='<tr style="cursor:pointer;" onclick="clickp('+i+')";>';
 textoT+='<td style="width:35%;color:white;background:DodgerBlue;" onclick="clickp('+i+')";>'+partes[0]+'</td>';
 textoT+='<td style="width:35%;color:white;background:DodgerBlue;" onclick="clickp('+i+')";>'+partes[1]+'</td>';
 textoT+='<td style="width:30%;color:white;background:DodgerBlue;" onclick="clickp('+i+')";>'+monto_factura(listasel[i])+'</td>';
 textoT+='</tr>'; 
}
}
textoT+='</table></div>';
div3.innerHTML=textoT;
}

function quitarlista(){
var div3 = document.getElementById("lista");
div3.style="display: none;";
}

function elim_factura(ind){
   facturas.splice(ind,1);
   localStorage.setItem("FACTURAS",JSON.stringify(facturas));
// guarda_facturas_IDB();
//  console.log('indice '+ind);
}

function borra(num){
var partes=listasel[num].split("_");
const resp = confirm("Esta seguro de eliminar la factura");
//var resp=prompt(,'S/N'); 
if (resp) {
var findice=facturas.findIndex((e)=>e.cliente==partes[0] && e.fecha==partes[1] && e.nro==partes[2]);
 if (findice>=0) {  
  elim_factura(findice)
 }
}
cancelar();
quitarlista();
selectlista(0);
}


function borra2(num){
var partes=listasel[num].split("_");
var findice=facturas.findIndex((e)=>e.cliente==partes[0] && e.fecha==partes[1] && e.nro==partes[2]);
 if (findice>=0) {  
  elim_factura(findice)
 }
cancelar();
}


function clickp(num){
//alert(num);
var nomb=listasel[num];
recupera_factura(nomb);
factura();
factura3(num);
quitarlista();

}

function cancelar(){
var div3 = document.getElementById("auxiliar");
div3.style="display:none;";
}


function fact_base(num){
var nomb=listasel[num];
anula();
recupera_factura(nomb);
for (var i=0;i<datfac.length;i++) {
if ((datfac[i].unidad!=0) || (datfac[i].cajas!=0)) {
 data[i][4]=datfac[i].unidad;
 data[i][5]=datfac[i].cajas;
//console.log(datfac[i].unidad+" "+datfac[i].pu+" "+datfac[i].cajas+" "+datfac[i].pb);
}
} 
factura2();
cancelar();
}
function modifica_factura2(indf){
fecha_factura=inv_fecha_date(document.getElementById('ffac').value.toLocaleString('es-US',{}));
cliente_factura=document.getElementById('cli2').value;
var nro_fact_m=document.getElementById('nfact').value;
try
{
facturas[indf].deuda=document.getElementById('dfact').value;
}catch{};
facturas[indf].cliente=cliente_factura;
facturas[indf].fecha=fecha_factura;
facturas[indf].nro=nro_fact_m;
localStorage.setItem("FACTURAS",JSON.stringify(facturas))
// guarda_facturas_IDB();
quitarlista();
lee_facturas();
selectlista(0);
}
 

function fact_modif(num){
//bcv_factura=ped[0];
var nomb=listasel[num];
partes=nomb.split("_");
var indf=facturas.findIndex((e)=>e.cliente==partes[0] && e.fecha==partes[1] && e.nro==partes[2])
var div3 = document.getElementById("lista");
div3.style="display:block; position: fixed;top :0px; left: 0px; width: 100%;height:40%;background-color: black;color:white; text-align: left; border: 3px solid #73AD21;";
//nro_factura=parseInt(localStorage.getItem('FACT_NRO'));
texto='';
texto+='Fecha: <input id="ffac" type="date" value="'+fecha_date(partes[1])+'"><br>';
texto+='<span onclick="limpiaCliente2();">Cliente:</span>';
texto+='<input style="width:30%;" type="text" id="cli2" value="'+partes[0]+'" list="listaclientes">';
texto+='<datalist id="listaclientes"></datalist>';
texto+='<input style="width:30%;" type="text" id="nfact" value="'+partes[2]+'" >';
try 
{texto+='<input style="width:30%;" type="text" id="dfact" value="'+facturas[indf].deuda+'" >';
}catch{};
texto+='<br><button onclick="quitarlista();" >Cancelar </button>&nbsp&nbsp&nbsp<button onclick="modifica_factura2('+indf+');" >Ok </button>';
div3.innerHTML=texto;
//anula();


//factura2();
//cancelar();
}
function revertir_factura(num){
var nomb=listasel[num];
recupera_factura(nomb);
//alert(cliente_factura.indexOf('Pedido'));
 if (cliente_factura.indexOf('Pedido')==-1) {suma_inventario2();}
cliente=cliente_factura;
var indcliente=AClientes.findIndex(x=>x.nombre==cliente);
//console.log(indcliente);
if (indcliente>=0) {Ocliente=AClientes[indcliente];} else {Ocliente=AClientes[0];}
fact_base(num);
borra2(num);
cancelar();
Revierte_deuda();
}
var MONTOF='';
function Actualiza_deuda(){
Lclientes=localStorage.getItem('Clientes_Pita');
if (Lclientes!=null) { AClientes=JSON.parse(Lclientes);} else {AClientes=[];}

var indcliente=AClientes.findIndex(x=>x.nombre==cliente);
//alert(indcliente);
if (indcliente>=0) {
DEU_ANT=AClientes[indcliente].deuda;
AClientes[indcliente].deuda=(parseFloat(AClientes[indcliente].deuda)+parseFloat(MONTOF)).toFixed(2);
AClientes[indcliente].ultfac=parseFloat(MONTOF).toFixed(2);
localStorage.setItem('Clientes_Pita',JSON.stringify(AClientes));
// guarda_clientes_IDB();
}
}
function Revierte_deuda(){
var indcliente=AClientes.findIndex(x=>x.nombre==cliente);
//alert(indcliente);
if (indcliente>=0) {
AClientes[indcliente].deuda=(parseFloat(AClientes[indcliente].deuda)-parseFloat(MONTOF)).toFixed(2);
localStorage.setItem('Clientes_Pita',JSON.stringify(AClientes));
// guarda_clientes_IDB();
//alert(AClientes[indcliente].deuda);
}

}

function guardar_factura(){
var div3 = document.getElementById("lista");
div3.style="display:block; position: fixed;top :0px; left: 0px; width: 100%;height:40%;background-color: black;color:white; text-align: left; border: 3px solid #73AD21;";
nro_factura=parseInt(localStorage.getItem('FACT_NRO'));
texto='';
texto+='Fecha: <input id="ffac" type="date" value="'+fecha_date(fecha_actual())+'"><br>';
texto+='<span onclick="limpiaCliente2();">Cliente:</span>';
texto+='<input style="width:30%;" type="text" id="cli2" value="'+cliente+'" list="listaclientes">';
texto+='<datalist id="listaclientes"></datalist>';
texto+='<input style="width:30%;" type="text" id="nfact" value="'+nro_factura+'" list="listaclientes">';
texto+='<br><button onclick="quitarlista();" >Cancelar </button>&nbsp&nbsp&nbsp<button onclick="guarda_factura2();" >Ok </button>';
div3.innerHTML=texto;

}

function guarda_factura2(){
fecha_factura=inv_fecha_date(document.getElementById('ffac').value.toLocaleString('es-US',{}));
//alert(fecha_factura);
cliente_factura=document.getElementById('cli2').value;
Actualiza_deuda();
guarda_factura(); 
localStorage.setItem('FACT_NRO',(nro_factura+1).toString());
quitarlista();
}
 
function guarda_factura(){
var indice=facturas.length;
var pu,pb;
var bcv=parseFloat(document.getElementById("t2").value);
var texto=(bcv).toFixed(4);

var nomb='FAC'+'_'+cliente_factura+'_'+fecha_factura+'_'+nro_factura;
nro_factura++;

localStorage.setItem('FACT_NRO',(nro_factura).toString());
facturas[indice]=new Object();
facturas[indice].cliente=cliente_factura;
facturas[indice].fecha=fecha_factura;
facturas[indice].nro=nro_factura;
facturas[indice].bcv=(bcv).toFixed(4);
facturas[indice].total=total_factura.toFixed(2);
facturas[indice].ganancia=Gdolar.toFixed(2);
facturas[indice].total_ret=MONTOF;
facturas[indice].deuda=DEU_ANT;
facturas[indice].items=new Array;
var nro_item=0;
for (var i=0;i<data.length;i++) {
if ((data[i][4]!=0) || (data[i][5]!=0)) { 
//console.log(data[i][4]+' '+data[i][5]);
 [pu,pb]=precio(i);
//console.log('pu '+pu+'pb '+pb);
 facturas[indice].items[nro_item]=new Object;
 facturas[indice].items[nro_item].cod=data[i][9];
 facturas[indice].items[nro_item].cu=data[i][4];
 facturas[indice].items[nro_item].pu=(pu).toFixed(2);
 facturas[indice].items[nro_item].cb=data[i][5];
 facturas[indice].items[nro_item].pb=(pb).toFixed(2);
 nro_item++;
 texto+='&'+data[i][9]+'#'+data[i][4]+'#'+(pu).toFixed(2)+'#'+data[i][5]+'#'+(pb).toFixed(2);
}
}
var tmp=JSON.stringify(facturas);
localStorage.setItem("FACTURAS",tmp);
// guarda_facturas_IDB();
//alert(tmp);
//if (texto.length>2) {localStorage.setItem(nomb,texto); } 
if (cliente_factura.indexOf('Pedido')==-1) {resta_inventario();}
//alert(facturas);
}


function recupera_pedido(archivo){
var texto='';
cliente=localStorage.getItem('Cliente');
document.getElementById("cli").value=cliente;
for (var i=0;i<data.length;i++) {
data[i][4]=0;
data[i][5]=0; 
}

texto=localStorage.getItem(archivo);


if (texto!='' && texto!=null) {
var ped=texto.split('&');

for (var i=0;i<ped.length;i++) {
  var items=ped[i].split('#');
  var ind=clave_ind.get(items[0]);
  data[ind][4]=parseInt(items[1]);
  data[ind][5]=parseInt(items[2]);
}
}

}

var datfac=[];

function monto_factura(nomb){
//alert(nomb);
var partes=nomb.split("_");
findice=facturas.findIndex((e)=>e.cliente==partes[0] && e.fecha==partes[1] && e.nro==partes[2]);
if (findice>=0) {return facturas[findice].total} else {return 0}
}

function monto_factura2(nomb){
//alert(nomb);
recupera_factura2(nomb);
//alert(nomb);
factura3(0);
document.getElementById("factura").hidden=true;
return (total_factura).toFixed(2);

}
function recupera_factura(id_factura){
//alert(id_factura);
for (var i=0;i<data.length;i++) {
datfac[i]=new Object();
datfac[i].unidad=0;
datfac[i].pu=0;
datfac[i].cajas=0;
datfac[i].pb=0;

}
var partes=id_factura.split('_');
fecha_factura=partes[1];
cliente_factura=partes[0];
numero_factura=partes[2];
//alert(numero_factura);
var indf=facturas.findIndex((e)=> e.cliente==cliente_factura && e.fecha==fecha_factura && e.nro==numero_factura);
//alert(indf);
if (indf>=0) {
 //alert(indf);
 bcv_factura=facturas[indf].bcv;
try {

 for (var i=0;i<facturas[indf].items.length;i++) {
   var ind=clave_ind.get(facturas[indf].items[i].cod);
if (ind!=undefined){
   datfac[ind].unidad=parseInt(facturas[indf].items[i].cu);
   datfac[ind].pu=parseFloat(facturas[indf].items[i].pu);
   datfac[ind].cajas=parseInt(facturas[indf].items[i].cb);
   datfac[ind].pb=parseFloat(facturas[indf].items[i].pb);
}
 }

} catch(error) {console.log(error)};
}
}

function recupera_factura2(nomb){

for (var i=0;i<data.length;i++) {
datfac[i]=new Object();
datfac[i].unidad=0;
datfac[i].pu=0;
datfac[i].cajas=0;
datfac[i].pb=0;

}
var partes=nomb.split('_');
fecha_factura=partes[1];
cliente_factura=partes[0];
numero_factura=partes[2];
//alert(nomb);
var texto=localStorage.getItem('FAC_'+nomb);
//alert(texto);
var items=texto.split('&');
 bcv_factura=items[0];
 for (var i=1;i<items.length;i++) {
  var det=items[i].split('#');
   var ind=clave_ind.get(det[0]);;
   datfac[ind].unidad=parseInt(det[1]);
   datfac[ind].pu=parseFloat(det[2]);
   datfac[ind].cajas=parseInt(det[3]);
   datfac[ind].pb=parseFloat(det[4]);
 }

}

function salir(){
guarda_pedido();
t2=document.getElementById("t2").value;
localStorage.setItem('p2',t2);
}

var lcat=[];
var Stack_cat=['D_PITA'];
var Cats;
var cat_actual='D_PITA';
var cat_ant='';

function set_cat(){
Cats = new Tree();
Cats.add('D_PITA','');
var categorias=[];
var ldatos=data.length;
for (i=0;i<ldatos;i++){
//console.log(data[i][8]);
 if (data[i][8]==1) {
  if  (!categorias.includes(data[i][7])) {
     categorias.push(data[i][7]);   
  } 
 }
}
var categ;
var nrocateg;
var ldatos2=categorias.length;
//console.log(ldatos2);
for (i=0;i<ldatos2;i++){
  categ=categorias[i].split('&');
  nrocateg=categ.length-2;
  //console.log(i + ' '+categ[1]+ ' '+ nrocateg);
  Cats.add(categ[1],'D_PITA');
  for (var j=2;j<=nrocateg;j++) {
     //console.log('subc '+ j+ ' '+categ[j]);
     Cats.add(categ[j],categ[j-1]);
   }
}

//console.log(Cats);
}

function check_inv(cod){

let cajas=0;
let unid=0;
let ind=inventario.findIndex(e=>e.CLAVE==cod);
if (ind!=-1) 
{
let i=clave_ind.get(inventario[ind]["CLAVE"]);
let total=parseInt(inventario[ind].CAJAS)*parseInt(data[i][1])+parseInt(inventario[ind].UNID);
cajas=Math.trunc(total/data[i][1]);unid=total % data[i][1];

}
return [cajas,unid];
}

function muestra_cat(){
var divcat=document.getElementById("cat");
var divarbol=document.getElementById("arbol");
cat_actual=Stack_cat[Stack_cat.length-1];
var text_cat='';
for (i=0;i<Stack_cat.length;i++)
    text_cat+=Stack_cat[i]+'/';
var nodo=Cats.findBFS(cat_actual) ;
var texto='';
texto+='<center>'+text_cat+'</center>';
if (Stack_cat.length>1) {
//texto+='  '+'<button class="nav" onclick="sube_cat()";>'+'&#9650'+'</button>'
}
//texto+='<br>';
divarbol.innerHTML=texto;
//cat_ant=cat_actual;
texto='';
for (i=0;i<nodo.children.length;i++){
  var aux=nodo.children[i].value;
  texto+='  '+'<button class="bot3" onclick="cambia_cat(\''+aux+'\')";>'+aux+'</button>';

}
divcat.innerHTML=texto;
divcat.style.visibility="visible";

//divcat.hidden=false;

}
function sube_cat(){
if (Stack_cat.length>1) { 
 Stack_cat.pop();
 muestra_cat();
refresca();
//console.log('paso sube');
}
}

function cambia_cat(valor){
Stack_cat.push(valor)
cat_ant=cat_actual;
//console.log('cat anterior  '+cat_ant);
cat_actual=valor.toString();
muestra_cat();
refresca();
//console.log('paso');
}

function  set_clave_indice(){
clave_ind=new Map();
for (var i=0;i<data.length;i++) {
//console.log(i);
//console.log(data[i][9]);

clave_ind.set(data[i][9],i.toString());
}
}

function ordena(){
data.sort(function(a, b){
  if (a.cat<b.cat) {return -1} else {return 0;}
   });
}

var dist="Distribuidora Pita-Orozco"
var hoy=new Date();
function camb(){
var va=document.getElementById("t3").checked; 
//console.log('va '+va);
localStorage.setItem('p3',va);
}
function carga(){
data=[];
var ftemp=localStorage.getItem("FACTURAS")
//alert(ftemp.length);
if (ftemp===null) {facturas=[];} else {facturas=JSON.parse(ftemp);}
//console.log(facturas);
//lee_facturas_IDB();
try {

document.getElementById("t2").value = localStorage.getItem('p2');
document.getElementById("fecha_p").innerText = localStorage.getItem('FECHA_P');
} catch (error) {  console.error(error); }

divt=document.getElementById("divt");
fiva=7.25;

var j=0;
Lee_clientes();


data= [["Vacio de cerveza Ret 222 ml x 36 UN",1,120,0,0,0,"t1","&Cerveceria&Vacios&",1,'CV001',120]
];

try {
data=eval(localStorage.getItem('data'));
} catch (error) {}
set_cat();

muestra_cat();
set_clave_indice();
inicio_inventario();
refresca();
recupera_pedido("Pedido");
}


function actT(ind){
var valor=prompt("Introduzca cantidad", "");
if (valor!=null) {data[ind][5]=parseInt(valor);}
intro(ind);

//console.log(ind);
}
function actU(ind){
var valor=prompt("Introduzca cantidad", "");
if (valor!=null) {data[ind][4]=parseInt(valor);}
intro(ind);

//console.log(ind);
}
var factflag=true;
function factura(){
if (factflag) {factflag=false; factura2(); } else { factflag=true; quitar()};

}
var Ftexto;

function fecha_actual(){
var dia=(hoy.getDate()).toString() ;
if (dia.length==1) {dia='0'+dia}
var mes=(hoy.getMonth()+1).toString();
if (mes.length==1) {mes='0'+mes}
return dia + '/' +mes + '/' +hoy.getFullYear().toString()

}

function factura3(numf){
var Tbs;
var totaldsiva=0;
var totalbsiva=0;
var texto='Fecha: '+fecha_factura+'<br>';
texto+=dist+'<br>';
texto+='Cliente: '+cliente_factura+'<br>';
try{
var bcv=parseFloat(bcv_factura);
}catch{};
var BIMD=0;
var factor=bcv;
Gdolar=0;
texto+='$ BCV: '+ (bcv).toFixed(4) +'<br>';
texto+='<center>Factura '+numero_factura+'</center>';
texto+='<center><span id="contad" ></span></center>';
var totald=0;
var totalb=0;
var indc=AClientes.findIndex(x=>x.nombre==cliente_factura);
if (indc>=0) {var cesp=AClientes[indc].esp} else {var cesp=false}
Ftexto='Fecha: '+fecha_factura+'\n';
Ftexto+=dist+'\n';
Ftexto+='Cliente: '+cliente_factura+'\n';
Ftexto+='$ BCV: '+  (bcv).toFixed(4) +'\n';
Ftexto+="FACTURA "+numero_factura+"\n"
var contador=0;
var colorb='black';
for (var i=0;i<datfac.length;i++){
 if (datfac[i].unidad!=0 || datfac[i].cajas!=0) {
 contador++;
 //console.log(i+ " "+contador);
 factor=bcv;
 if (data[i][3]==1) {fm=1.16;colorb='black';} else {fm=1;colorb='blue';}

 pu=datfac[i].pu;
 pb=datfac[i].pb;
[pcu,pcb]=precio_costo(i);
 var Tdolar=+((datfac[i].unidad*pu + datfac[i].cajas*pb));
 Gdolar+=fm*((datfac[i].unidad*(pu-pcu) + datfac[i].cajas*(pb-pcb)));
 Tbs=Tdolar*factor;

if (Tdolar==Tdolar) { 
   if (fm!=1) {BIMD+=Tdolar;}
  Ftexto+='------------\n';
 texto+='<table width="100%">';
 if (tipo2==0) {var mone=' $'; var fc=1 }
 if (tipo2==1) {var mone=' Bs'; var fc=bcv }
    if (datfac[i].unidad!=0) { 
      v2=(pu*fc).toFixed(2);
      v3=(parseFloat(v2)*datfac[i].unidad).toFixed(2);
      v4=(parseFloat(v3)*fm).toFixed(2);
      if (tipo2==1) {totalb+=parseFloat(v4); totalbsiva+=parseFloat(v3);} else 
         {totald+=parseFloat(v4); totaldsiva+=parseFloat(v3);}
         texto+='<tr><td colspan="4" style=" font-size:1.5em;background-color:'+colorb+';color:white;" >'+ datfac[i].unidad +' U '+ data[i][0]+'</td></tr>';
         texto+='<tr style="text-align:right;font-size:0.5em;"><td style="width:10%;">'+datfac[i].unidad+'</td><td style="width:30%;">'+v2+mone+'</td><td style="width:30%;">'+v3+mone+'</td><td style="width:30%;">'+ v4 +mone+'&nbsp'+'</tr>';
         Ftexto+=datfac[i].unidad +' U '+ data[i][0]+'\n';
         Ftexto+=datfac[i].unidad+' U     '+v2+mone+' S/IVA: '+v3+mone+"   C/IVA: "+ v4 + mone +'    \n'
    }
   if (datfac[i].cajas!=0) {
      v2=(pb*fc).toFixed(2);
      v3=(parseFloat(v2)*datfac[i].cajas).toFixed(2);
      v4=(parseFloat(v3)*fm).toFixed(2);
      if (tipo2==1) {totalb+=parseFloat(v4); totalbsiva+=parseFloat(v3);} else 
         {totald+=parseFloat(v4); totaldsiva+=parseFloat(v3);}
      texto+='<tr><td colspan="4" style="font-size:1.5em;background-color:'+colorb+';color:white;" >'+ datfac[i].cajas +' C  ' + data[i][0]+' </td></tr>';
      texto+='<tr style="text-align:right;font-size:0.5em;"><td style="width:10%;">'+datfac[i].cajas+'</td><td style="width:30%;">'+v2+mone+'</td><td style="width:30%;">'+v3+mone+'</td><td style="width:30%;">'+ v4 +mone+'&nbsp'+'</tr>';
      Ftexto+=datfac[i].cajas +' C '+ data[i][0]+'\n';;
      Ftexto+=datfac[i].cajas +' C     '+v2+mone+' S/IVA: '+v3+"   C/IVA: "+v4 + mone+'    \n'
    }
}
}
}
texto+='</table>';


texto+='<HR>';
Ftexto+='============================================\n';
//texto+='<span style="color:yellow; font-size:1em;">Total</span><br>';

var IVAD=(totald-totaldsiva).toFixed(2);

BIMD=(BIMD).toFixed(2);
var BIMB=(parseFloat(BIMD)*factor).toFixed(2);
var descd=(parseFloat(IVAD)*0.75).toFixed(2);
var IVAB=(totalb-totalbsiva).toFixed(2);
var descb=(parseFloat(IVAB)*0.75).toFixed(2);


if (tipo2==0){
texto+='<table width="60%">';
texto+='<tr align="right"><td style="width:50%;color:#000066;width:50%;"> Total S/IVA </td><td style="width:50%;">'+(totaldsiva).toFixed(2)+' '+mone+'</td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> B. Imp. </td><td style="width:50%;">'+BIMD+' '+mone+' </td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> IVA </td><td style="width:50%;">'+IVAD+' '+mone+' </td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total </td><td style="width:50%;">'+(totald).toFixed(2)+' '+mone+' </td></tr>';
if (cesp) {
texto+='<tr align="right"><td style="color:#000066; width:50%;"> Dcto AR </td><td style="width:50%;">'+(parseFloat(descd)).toFixed(2)+' '+mone+' </td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total AR </td><td style="width:50%;">'+(totald-parseFloat(descd)).toFixed(2)+' '+mone+' </td></tr>';
}
texto+='</table>';
Ftexto+='S/IVA: '+(totaldsiva).toFixed(2)+' '+mone+'  C/IVA: '+(totald).toFixed(2)+' '+mone+ ' \n'
Ftexto+='IVA: '+IVAD+' '+mone+' \n';

}

total_factura=totald;
if (cesp) {
MONTOF=totald-parseFloat(descd);
} else {MONTOF=total_factura};
if (tipo2==1) {
texto+='<table width="60%">';
texto+='<tr align="right"><td style="color:#000066; width:50%;">Total S/IVA  </td><td style="width:50%;">'+(totalbsiva).toFixed(2)+' '+mone+ '</td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> B. Imp. </td><td style="width:50%;">'+BIMB+' '+mone+' </td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> IVA </td><td style="width:50%;">'+IVAB+' '+mone+'</td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total </td><td style="width:50%;">'+(totalb).toFixed(2)+' '+mone+'</td></tr>';
if (cesp) {
texto+='<tr align="right"><td style="color:#000066; width:50%;"> Dcto AR </td><td style="width:50%;">'+(parseFloat(descb)).toFixed(2)+' '+mone+'</td></tr>';
texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total AR </td><td style="width:50%;">'+(totalb-parseFloat(descb)).toFixed(2)+' '+mone+'</td></tr>';
}
texto+='</table>';
Ftexto+='S/IVA: '+(totalbsiva).toFixed(2)+' '+mone+' C/IVA: '+(totalb).toFixed(2)+' '+mone+' \n'
Ftexto+='IVA: '+(totalb-totalbsiva).toFixed(2)+' '+mone+ ' \n';
}
//console.log(Ftexto);
var TM2="";
if (tipo2==0) {TM2="$";} else {TM2="Bs";}

var textoT='<div style="position: fixed; text-align:right;background-color: lightgreen;width:100%;">';
textoT+='<table width="100%"';
textoT+='<tr>';
textoT+='<td width="15%"><button class="btop" onclick="borra('+numf+');">Borrar</button></td>';
textoT+='<td width="15%"><button class="btop" onclick="revertir_factura('+numf+');">Revertir</button></td>';
textoT+='<td width="15%"><button class="btop" onclick="fact_base('+numf+');">Estab</button></td>';
textoT+='<td width="15%"><button class="btop" onclick="fact_modif('+numf+');">Modif</button></td>';
textoT+='<td width="10%"></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Cambia moneda" id="tipo_factura" onclick="cambia_moneda2('+numf+');">' + TM2 +'</button></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Compartir" id="btnc" onclick="compartir();"> C </button></td>';
textoT+='<td width="10%"><button  style="font-size: 0.9em;" title="Salir" onclick="quitar();" > x </button></td>';
textoT+='</tr></table></div><br>';
divfactura=document.getElementById("factura")
divfactura.style="position: fixed;top :35px; left: 2px; overflow-y: auto; width: 100% ; height: 80%; background-color: lightgray;color:white; border: 3px solid #73AD21;";
textoT+='<div style="color:black; font-size:0.8em;">'+texto+'</div>';
divfactura.innerHTML=textoT;
divfactura.hidden=false;
//console.log("contador: "+contador);
document.getElementById("contad").innerText=contador+ " Productos";
}

var Ptexto;

function pedido(){
const resp = confirm("Esta seguro de hacer el pedido ");
if (resp) {
Ptexto='Pedido de alimentos de Distribuidora Pita Orozco\n';
Ptexto+='Codigo: 2240066\n'
Ptexto+='-----------\n';
for (var i=0;i<data.length;i++){
if (data[i][4]!=0 ) {Ptexto+= data[i][4]+' U '+data[i][0]+'\n';}
  if (data[i][5]!=0) {Ptexto+= data[i][5]+' '+data[i][0]+'\n';}

}
//console.log(Ptexto);

const shareData = {
  title: 'Pedido',
  text: Ptexto
}
comparte(shareData);
}
}

function factura2(){
var Tbs;
var totaldsiva=0;
var totalbsiva=0;
var BIMD=0;
var bcv=parseFloat(document.getElementById("t2").value);
var factor=parseFloat(bcv);
var texto='<table width="100%" ><tr><td>Fecha: '+fecha_actual()+'</td><td>  $ BCV: '+ (bcv).toFixed(4) +'</td></tr></table>';
texto+=dist+'<br>';
texto+='Cliente: '+cliente+'<br>';
texto+='Direcci&oacute;n: '+Ocliente.dir+'<br>';
texto+='Rif: '+Ocliente.rif;
if (Ocliente.esp) {texto+=' AR';}
texto+='<br>'
//texto+='$ Paralelo: '+  impri(document.getElementById("t1").value) +'<br>';
//texto+='$ BCV: '+ (bcv).toFixed(4) +'<br>';
texto+="<center>Factura</center>";
texto+='<center><span id="contad" ></span></center>';
var totald=0;
var totalb=0;
Ftexto='Fecha: '+fecha_actual()+'\n';
Ftexto+=dist+'\n';
Ftexto+='Cliente: '+cliente+'\n';
Ftexto+='$ BCV: '+  (bcv).toFixed(4) +'\n';
Ftexto+="FACTURA\n"
var contador=0;
var colorb='black';
Tdolar=0;
Gdolar=0;
for (var i=0;i<data.length;i++){
  if (data[i][4]!=0 || data[i][5]!=0) {
    contador++;
    factor=parseFloat(document.getElementById("t2").value);
    if (data[i][3]==1) {fm=1.16;colorb='black'} else {fm=1;colorb='blue'}
    [pu,pb]=precio(i);
    [pcu,pcb]=precio_costo(i);
    Tdolar=+((data[i][4]*pu + data[i][5]*pb));
    Gdolar+=fm*((data[i][4]*(pu-pcu) + data[i][5]*(pb-pcb)));
    if (data[i][6]=="t1") {
     Tbs= data[i][4]*(data[i][2]) + data[i][5]*data[i][2]*data[i][1];
    } else 
        {
    Tbs=parseFloat((Tdolar*factor).toFixed(2));
    }
  if (Tdolar==Tdolar) { 
     if (fm!=1) {BIMD+=Tdolar;}
     totald+=parseFloat((Tdolar*fm).toFixed(2));
     totaldsiva+=parseFloat((Tdolar).toFixed(2));
     Ftexto+='------------\n';
     texto+='<table width="100%">';
     if (tipo==0) {
       if (data[i][4]!=0) { 
         v2=(pu).toFixed(2);
         v3=(parseFloat(v2)*data[i][4]).toFixed(2);
         v4=(parseFloat(v3)*fm).toFixed(2);
         texto+='<tr><td colspan="4" style=" font-size:1.5em;background-color:'+colorb+';color:white;" onclick="cintro('+i+');">'+ data[i][4] +' U '+ data[i][0]+'</td></tr>';
         texto+='<tr style="text-align:right;font-size:0.5em;"><td style="width:10%;">'+data[i][4]+'</td><td style="width:30%;">'+v2+'$'+'</td><td style="width:30%;">'+v3+' $'+'</td><td style="width:30%;">'+ v4 +' $&nbsp'+'</tr>';
         Ftexto+=data[i][4] +' U '+ data[i][0]+'\n';
         Ftexto+=data[i][4]+' U     '+v2+' $'+'S/IVA: '+v3+"   C/IVA: "+v4 + ' $    \n'
       }
       if (data[i][5]!=0) {
         v2=(pb).toFixed(2);
         v3=(parseFloat(v2)*data[i][5]).toFixed(2);
         v4=(parseFloat(v3)*fm).toFixed(2);
         texto+='<tr><td colspan="4" style="font-size:1.5em;background-color:'+colorb+';color:white;" onclick="cintro('+i+');">'+ data[i][5] +' C  ' + data[i][0]+' </td></tr>';
         texto+='<tr style="text-align:right;font-size:0.5em;"><td style="width:10%;">'+data[i][5]+'</td><td style="width:30%;">'+v2+'$'+'</td><td style="width:30%;">'+v3+' $'+'</td><td style="width:30%;">'+v4 +' $&nbsp'+'</tr>';
         Ftexto+=data[i][5] +' C '+ data[i][0]+'\n';;
         Ftexto+=data[i][5]+' C     '+v2+' $'+'S/IVA: '+v3+"   C/IVA: "+v4 + ' $    \n'
       }
     }
     if (tipo==1) {
       if (data[i][4]!=0) { 
         v2=(pu*factor).toFixed(2);
         v3=(parseFloat(v2)*data[i][4]).toFixed(2);
         v4=(parseFloat(v3)*fm).toFixed(2);
         totalb+=parseFloat(v4);
         totalbsiva+=parseFloat(v3);
         texto+='<tr><td colspan="4" style=" font-size:1.5em;background-color:'+colorb+';color:white;" onclick="cintro('+i+');">'+ data[i][4] +' U '+ data[i][0]+'</td></tr>';
         texto+='<tr style="text-align:right;font-size:0.3em;"><td style="width:10%;">'+data[i][4]+'</td><td style="width:30%;">'+v2+'Bs'+'</td><td style="width:30%;">'+v3+' Bs'+'</td><td style="width:30%;">'+ v4 +' Bs&nbsp'+'</tr>';
         Ftexto+=data[i][4] +' U '+ data[i][0]+'\n';
         Ftexto+=data[i][4]+' U     '+v2+' Bs'+'S/IVA: '+v3+"   C/IVA: "+v4 + ' Bs    \n'
       }
       if (data[i][5]!=0) {
         v2=(pb*factor).toFixed(2);
         v3=(parseFloat(v2)*data[i][5]).toFixed(2);
         v4=(parseFloat(v3)*fm).toFixed(2);
         totalb+=parseFloat(v4);
         totalbsiva+=parseFloat(v3);
         texto+='<tr><td colspan="4" style="font-size:1.5em;background-color:'+colorb+';color:white;" onclick="cintro('+i+');">'+ data[i][5] +' C  ' + data[i][0]+' </td></tr>';
         texto+='<tr style="text-align:right;font-size:0.3em;"><td style="width:10%;">'+data[i][5]+'</td><td style="width:30%;">'+v2+'Bs'+'</td><td style="width:30%;">'+v3+' Bs'+'</td><td style="width:30%;">'+ v4 +' Bs&nbsp'+'</tr>';
         Ftexto+=data[i][5] +' C '+ data[i][0]+'\n';;
         Ftexto+=data[i][5]+' C     '+v2+' Bs'+'S/IVA: '+v3+"   C/IVA: "+v4 + ' Bs    \n'
       }
    }
  }
  texto+='</table>';
  } // if
 }// for

texto+='<HR>';
Ftexto+='============================================\n';
var TM="";
if (tipo==0) {TM="$";} else {TM="Bs";}

//var IVAD=(totald-totaldsiva).toFixed(2);
BIMD=(BIMD).toFixed(2);
var IVAD=(BIMD*0.16).toFixed(2);
var BIMB=(parseFloat(BIMD)*factor).toFixed(2);
var descd=(parseFloat(IVAD)*0.75).toFixed(2);
var IVAB=(parseFloat(IVAD)*factor).toFixed(2);
var descb=(parseFloat(IVAB)*0.75).toFixed(2);
totald=parseFloat(totaldsiva)+parseFloat(IVAD);

if (tipo==0) {
  texto+='<table width="60%">';
  texto+='<tr align="right"><td style="width:50%;color:#000066;width:50%;"> Total S/IVA </td><td style="width:50%;">'+(totaldsiva).toFixed(2)+' '+TM+'</td></tr>';
  texto+='<tr align="right"><td style="color:#000066; width:50%;"> B. Imp. </td><td style="width:50%;">'+BIMD+' '+TM+' </td></tr>';
  texto+='<tr align="right"><td style="color:#000066; width:50%;"> IVA </td><td style="width:50%;">'+IVAD+' '+TM+' </td></tr>';
  texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total </td><td style="width:50%;">'+(totald).toFixed(2)+' '+TM+' </td></tr>';
  if (Ocliente.esp) {
   texto+='<tr align="right"><td style="color:#000066; width:50%;"> Dscto AR </td><td style="width:50%;">'+(parseFloat(descd)).toFixed(2)+' '+TM+' </td></tr>';
   texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total AR </td><td style="width:50%;">'+(totald-parseFloat(descd)).toFixed(2)+' '+TM+' </td></tr>';
  }
  texto+='</table>';
  Ftexto+='S/IVA: '+(totaldsiva).toFixed(2)+' '+TM+'  C/IVA: '+(totald).toFixed(2)+' '+TM+ ' \n'
  Ftexto+='IVA: '+IVAD+' '+TM+' \n';
}
total_factura=totald;
if (Ocliente.esp) {
 MONTOF=(totald-parseFloat(descd)).toFixed(2);
} else {MONTOF=(totald).toFixed(2)}
if (tipo==1) {
  texto+='<table width="60%">';
  texto+='<tr align="right"><td style="color:#000066; width:50%;">Total S/IVA  </td><td style="width:50%;">'+(totalbsiva).toFixed(2)+' '+TM+ '</td></tr>';
  texto+='<tr align="right"><td style="color:#000066; width:50%;"> B. Imp. </td><td style="width:50%;">'+BIMB+' '+TM+' </td></tr>';
  texto+='<tr align="right"><td style="color:#000066; width:50%;"> IVA </td><td style="width:50%;">'+IVAB+' '+TM+'</td></tr>';
  texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total </td><td style="width:50%;">'+(totalb).toFixed(2)+' '+TM+'</td></tr>';
  if (Ocliente.esp) {
    texto+='<tr align="right"><td style="color:#000066; width:50%;"> Dcto AR </td><td style="width:50%;">'+(parseFloat(descb)).toFixed(2)+' '+TM+'</td></tr>';
    texto+='<tr align="right"><td style="color:#000066; width:50%;"> Total AR </td><td style="width:50%;">'+(totalb-parseFloat(descb)).toFixed(2)+' '+TM+'</td></tr>';
  }
texto+='</table>';
Ftexto+='S/IVA: '+(totalbsiva).toFixed(2)+' '+TM+' C/IVA: '+(totalb).toFixed(2)+' '+TM+' \n'
Ftexto+='IVA: '+(totalb-totalbsiva).toFixed(2)+' '+TM+ ' \n';
}

var textoT='<div style="position: fixed; text-align:right;background-color: gray;width:100%;">';
textoT+='<table width="100%"';
textoT+='<tr>';
textoT+='<td width="15%"><button class="btop" onclick="anula();">Borrar</button></td>';
textoT+='<td width="15%"><button class="btop" onclick="guardar_factura();">Guardar</button></td>';
textoT+='<td width="15%"><button class="btop" onclick="lee_facturas();selectlista(0);">Ver</button></td>';
textoT+='<td width="5%"></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Cambia moneda" id="tipo_factura" onclick="cambia_moneda();">' + TM +'</button></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Compartir" id="btnc" onclick="compartir();"> C </button></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Inventario" id="btnc" onclick="suma_inventario();"> +I </button></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Inventario" id="btnc" onclick="restar_inventario();"> -I </button></td>';
textoT+='<td width="10%"><button style="font-size: 0.9em;" title="Pedido" id="btnc" onclick="pedido();"> P </button></td>';
textoT+='<td width="10%"><button  style="font-size: 0.9em;" title="Salir" onclick="quitar();" > x </button></td>';
textoT+='</tr></table></div><br>';
divfactura=document.getElementById("factura")
divfactura.style="position: fixed;top :35px; left: 2px; overflow-y: auto; width: 100% ; height: 80%; background-color: lightgray;color:white; border: 3px solid #73AD21;";
textoT+='<div style="color:black; font-size:0.8em;">'+texto+'</div>';
divfactura.innerHTML=textoT;
divfactura.hidden=false;
document.getElementById("contad").innerText=contador+ " Productos";
}

var tipo=0;
var tipo2=0;

function cambia_moneda(){
tipo=1-tipo;
factura2();
}

function cambia_moneda2(num){
tipo2=1-tipo2;
//alert();
factura3(num);
}

function compartir(){
const shareData = {
  title: 'Factura',
  text: Ftexto
}
//console.log(shareData);
comparte(shareData);
}

async function comparte(shareData){
  try {
    await navigator.share(shareData)
    console.log('MDN shared successfully');
  } catch(err) {
    console.log( 'Error: ' + err);
  }
}


function anula(){

const resp = confirm("Esta seguro de borrar la factura ");
if (resp) {
 for (var i=0;i<data.length;i++){
  data[i][4]=0;
  data[i][5]=0;
 }
}
if (document.getElementById("factura").hidden==false) {factura2();}
}

function quitar(){
var div5 = document.getElementById("factura");
div5.hidden=true;
factflag=true;
}
function precio_costo(ind){
var factor=parseFloat(document.getElementById("t2").value);
if (data[ind][6]=="t1") {
 var pcu=+(data[ind][10]*(1/factor)).toFixed(2);
 var pcb=+(pcu*data[ind][1]);
} 
if (data[ind][6]=="t2") {
   var pcu=+(data[ind][10]).toFixed(2);
   var pcb=+(pcu*data[ind][1]);
    } 
if (data[ind][6]=="t3") {
   var pcb=+(data[ind][10].toFixed(2));
   var pcu=+((pcb/data[ind][1]).toFixed(2));
    }

pcu=parseFloat(pcu.toFixed(2));
pcb=parseFloat(pcb.toFixed(2));
//alert('pu'+pu+' pb '+pb);
return [pcu,pcb];
}

function precio(ind){
var factor=parseFloat(document.getElementById("t2").value);
if (data[ind][6]=="t1") {
 var pu=+(data[ind][2]*(1/factor)).toFixed(8);
 var pb=+(pu*data[ind][1]);
} 
if (data[ind][6]=="t2") {
   var pu=+(data[ind][2]).toFixed(2);
   var pb=+(pu*data[ind][1]);
    } 
if (data[ind][6]=="t3") {
   var pb=+(data[ind][2].toFixed(2));
   var pu=+((pb/data[ind][1]).toFixed(2));
    }

pu=parseFloat(pu.toFixed(8));
pb=parseFloat(pb.toFixed(8));
//alert('pu'+pu+' pb '+pb);
return [pu,pb];
}


function refresca2(){
var patron=document.getElementById("search").value.toUpperCase();
var pb;
var pu;
//t1=document.getElementById("t1").value;
t2=document.getElementById("t2").value;
//localStorage.setItem('p1',t1);
localStorage.setItem('p2',t2);
texto="";
var factor;
var fm;
var pu,pb;
for (var i=0;i<data.length;i++){
if (data[i][0].toUpperCase().indexOf(patron) !=-1)   {
if (data[i][6]=="t1") {factor=t2;}
if (data[i][6]=="t2") {factor=t2;}
//console.log(i+" "+data[i][0]);
texto+='<p  >'+ data[i][0]+'</p>';
//console.log(data[i][0]+' ' +(data[i][2]).toFixed(2));
if (data[i][4]==0) {var vcor='black';} else {var vcor='blue';}
if (data[i][5]==0) {var vcor1='black';} else {var vcor1='blue';}
if (data[i][3]==1) {fm=1.16} else {fm=1}
//var pu=+(fm*data[i][2]/data[i][1]).toFixed(2);
//var pb=+(fm*data[i][2]).toFixed(2);
/*if (data[i][6]=="t1") {
  var pu=+(fm*data[i][2]*(1/t2)).toFixed(2);
  var pb=+(pu*data[i][1]).toFixed(2);
} 
if (data[i][6]=="t2") {
  var pu=+(fm*data[i][2]).toFixed(2);
  var pb=+(pu*data[i][1]).toFixed(2);
}

if (data[i][6]=="t3") {
  var pb=+(fm*data[i][2]).toFixed(2);
  var pu=+(pb/data[i][1]).toFixed(2);
}
*/
[pu,pb]=precio(i);
if (data[i][6]=="t1") 
{
texto+='<table><tr><td> U '+(pu).toFixed(2)+' $' +'</td><td>'+ (fm*data[i][2]).toFixed(2)+ ' Bs <button class="btn2" style="color:'+vcor+';"'+'onclick="actU('+i+');">'+data[i][4]+'</button></td></tr>';
texto+='<tr><td> B '+(pb).toFixed(2)+' $'+'</td><td>'+ (fm*data[i][2]*data[i][1]).toFixed(2)+ ' Bs <button class="btn2" style="color:'+vcor1+';"'+'onclick="actT('+i+');">'+data[i][5]+'</button></td></tr></table>';
} 
if (data[i][6]=="t2") 
{
texto+='<table><tr><td> U '+(pu).toFixed(2)+' $' +'</td><td>'+ (pu*factor).toFixed(2)+ ' Bs <button class="btn2" style="color:'+vcor+';"'+'onclick="actU('+i+');">'+data[i][4]+'</button></td></tr>';
texto+='<tr><td> B '+(pb).toFixed(2)+' $'+'</td><td>'+ (pb*factor).toFixed(2)+ ' Bs <button class="btn2" style="color:'+vcor1+';"'+'onclick="actT('+i+');">'+data[i][5]+'</button></td></tr></table>';
}
  
if (data[i][6]=="t3") 
{
texto+='<table><tr><td> U '+(pu).toFixed(2)+' $' +'</td><td>'+ (pu*factor).toFixed(2)+ ' Bs <button class="btn2" style="color:'+vcor+';"'+'onclick="actU('+i+');">'+data[i][4]+'</button></td></tr>';
texto+='<tr><td> B '+(pb).toFixed(2)+' $'+'</td><td>'+ (pb*factor).toFixed(2)+ ' Bs <button class="btn2" style="color:'+vcor1+';"'+'onclick="actT('+i+');">'+data[i][5]+'</button></td></tr></table>';
}


 if (data[i][3]==1) {
    texto+="<span style='font-size:0.6em;'>Retenci&oacute;n T: "+(fm*data[i][2]/fiva).toFixed(2)+ " $ "+(fm*data[i][2]*factor/fiva).toFixed(2)+" Bs          </span>";
   }
}
}
texto+='<br><br>'
divt.innerHTML=texto;
}
function preciou(i){
var fm
if (data[i][3]==1) {fm=1.16} else {fm=1}
if (data[i][6]=="t1") {
  var pu=+(fm*data[i][2]*(1/t2)).toFixed(2);
  var pb=+(pu*data[i][1]).toFixed(2);
} 
if (data[i][6]=="t2") {
  var pu=+(fm*data[i][2]).toFixed(2);
  var pb=+(pu*data[i][1]).toFixed(2);
}

if (data[i][6]=="t3") {
  var pb=+(fm*data[i][2]).toFixed(2);
  var pu=+(pb/data[i][1]).toFixed(2);
}
return pu;
}

function preciob(i){
var fm
if (data[i][3]==1) {fm=1.16} else {fm=1}

if (data[i][6]=="t1") {
  var pu=+(fm*data[i][2]*(1/t2)).toFixed(2);
  var pb=+(pu*data[i][1]).toFixed(2);
} 
if (data[i][6]=="t2") {
  var pu=+(fm*data[i][2]).toFixed(2);
  var pb=+(pu*data[i][1]).toFixed(2);
}

if (data[i][6]=="t3") {
  var pb=+(fm*data[i][2]).toFixed(2);
  var pu=+(pb/data[i][1]).toFixed(2);
}
return pb;
}
function quitar_intro(){
document.getElementById("introd").style.visibility="hidden";
}

function cambiaU(num){
data[num][4]=document.getElementById("entradaU").value;
if (data[num][4]=='') {data[num][4]=0}
intro(num);
salir();
}
function cambiaB(num){
data[num][5]=document.getElementById("entradaB").value;
if (data[num][5]=='') {data[num][5]=0}
intro(num);
salir();
}
function cintro(num){
document.getElementById("factura").hidden=true;
factflag=true;
intro(num);
}

function intro(i){
[dpc,dpu]=check_inv(data[i][9]);
var totalsivabs;
var totalsivad;
var fm;
var factor=parseFloat(document.getElementById("t2").value);
var BanderaIva;
var colb="black";
if (data[i][3]==1) {fm=1.16;BanderaIva="C/IVA";colb="black";} else {fm=1;BanderaIva="S/IVA";colb="blue";}
var divintro=document.getElementById("introd");
if (data[i][4]==0) {var vcor='red';} else {var vcor='blue';}
if (data[i][5]==0) {var vcor1='red';} else {var vcor1='blue';}
//var pu=preciou(i);
//var pb=preciob(i);
[pu,pb]=precio(i);
var texto='<table width="100%" style="background-color:'+colb+';color:white;"><tr ><td >'+data[i][0]+' '+BanderaIva+' '+'<span style="color:yellow;">'+dpc+ ' C '+dpu+' U'+'</span>'+'</td><td style="text-align:left;"><button onclick="quitar_intro();">x</button></td></tr></table>';

var pc=parseFloat(data[i][10]);

var ga;
if (data[i][6]=='t3')   {ga=(((pb-pc)/pb)*100).toFixed(2);}
if (data[i][6]=='t2')   {ga=(((pu-pc)/pu)*100).toFixed(2);}
var puiva=(pu*fm).toFixed(2)
var pbiva=(pb*fm).toFixed(2)
tex1='U '+puiva+' $';
tex2=(puiva*factor).toFixed(2)+ ' Bs';
tex3='C '+pbiva +' $';
tex4=(pbiva*factor).toFixed(2)+ ' Bs';

if (data[i][4]==0) {var valoru="";} else {var valoru=data[i][4];}
if (data[i][5]==0) {var valorb="";} else {var valorb=data[i][5];}

texto+='<table><tr><td>'+tex1+'</td><td>'+tex2+'</td><td><input id="entradaU" type="number" class="btn2" style="color:'+vcor+';" value="'+valoru+'" onchange="cambiaU('+i+');"></td><td>'+ga+ '</td></tr>';
texto+='<tr><td>'+tex3+'</td><td>'+tex4+'</td><td><input id="entradaB" type="number" class="btn2" style="color:'+vcor1+';" value="'+valorb+'" onchange="cambiaB('+i+');"></td><td></td></tr></table>';


totalsivad=((pu)*data[i][4]+(pb)*data[i][5]);
totalsivabs=totalsivad*factor;

 texto+='<table width="100%"><tr><td>Total S/IVA</td><td style="text-align:right;">'+(totalsivad).toFixed(2)+'</td><td style="color:blue:">$</td><td style="text-align:right;">'+(totalsivabs).toFixed(2)+'</td><td>Bs</td></tr>';
 texto+='<tr><td>Total C/IVA</td><td style="text-align:right;">'+(totalsivad*fm).toFixed(2)+'</td><td>$</td><td style="text-align:right;">'+(totalsivabs*fm).toFixed(2)+'</td><td>Bs</td></tr>';
 texto+='<tr><td>Diferencia IVA</td><td style="text-align:right;">'+(totalsivad*(fm-1)).toFixed(2)+'</td><td>$</td><td style="text-align:right;">'+(totalsivabs*(fm-1)).toFixed(2)+'</td><td>Bs</td></tr>';
 
texto+='</table>';

divintro.innerHTML=texto;
divintro.style.visibility = "visible";
//console.log('num '+i);
//console.log(divintro);
}

function refresca(){
//var patron=document.getElementById("search").value.toUpperCase();
var pb;
var pu;
//t1=document.getElementById("t1").value;
t2=document.getElementById("t2").value;
//localStorage.setItem('p1',t1);
localStorage.setItem('p2',t2);
texto="";
var factor;
var fm;
var cat_comp='&';
for (var i=1;i<Stack_cat.length;i++) {
 cat_comp+=Stack_cat[i]+'&';
}
var hay=false;
for (var i=0;i<data.length;i++){
if ((data[i][7]==cat_comp) && (data[i][8]==1))  
{
 //console.log(data[i][8]);
 hay=true;
 if (data[i][6]=="t1") {factor=t2;}
 if (data[i][6]=="t2") {factor=t2;}
//console.log(i+" "+data[i][0]);
texto+='<button class="bot4" onclick="intro('+i+');">'+ data[i][0]+'</button><br>';
//console.log(data[i][0]+' ' +(data[i][2]).toFixed(2));

}

}
texto+='<br><br>'
divt.innerHTML=texto;
if (!hay) {
   document.getElementById("introd").style.visibility = "hidden";}
   else {
   document.getElementById("cat").style.visibility = "hidden";
}
}

function impri(A){
var At=A.toString();
var p=At.indexOf('.');
var num=At.substring(0,p);
var dec=At.substring(p+1,At.length);
//console.log(p+" "+num+" "+dec);
var B="";
var j=0;
var indfin=num.length
var porc=[];
while (indfin>0) {
porc[j]=num.substring(indfin-3,indfin);
indfin=indfin-3;
j=j+1;
}

for(var j=porc.length-1;j>0;j--)
{
B=B+porc[j]+".";
}
B=B+porc[0]+","+dec
//console.log(B);
return B;
}
impri(12356.3478);

</script>
<script>

// Registra el service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
      // Si es exitoso
      console.log('SW registrado correctamente');
    }, function(err) {
      // Si falla
      console.log('SW fallo', err);
    });
  });
}
Act_data();

function Act_data(){
var myHeaders = new Headers();

var myInit = { mode: 'cors' };

//var nombrepag="https://monitordolarvenezuela.com/monitor-dolar-hoy";
var nombrepag="https://bdeabreu66.github.io/factura/precios.txt";


fetch(nombrepag,myInit)
        .then(ajaxPositive)
        .catch(showError);

function ajaxPositive(response) {
      console.log('response.ok: ', response.ok);
      if(response.ok) {
        response.text().then(showResult);
      } else {
        showError('status code: ' + response.status);
      }
    }
 function showResult(txt) {
        //console.log('muestro respuesta: ', txt);
        localStorage.setItem('data',txt);
        data=eval(txt);
        set_clave_indice();
        set_cat();
        muestra_cat();
        inicio_inventario();
        refresca();
        recupera_pedido("Pedido");
        set_var_voz();
  }

function showError(err) { 
      console.log('muestor error', err);
    }
}

function Actualiza_dolar(){
var nomb="https://s3.amazonaws.com/dolartoday/data.json"
//var myHeaders = new Headers();
var myInit = { mode: 'cors' };

fetch(nomb,myInit)
        .then(ajaxPositiveD)
        .catch(showErrorD);

function ajaxPositiveD(response) {
      console.log('response.ok: ', response.ok);
      if(response.ok) {
        response.json().then(showResultD);
      } else {
        showErrorD('status code: ' + response.status);
      }
    }
 function showResultD(txt) {
       console.log('muestro respuesta: ', txt.USD.sicad2);
       //document.getElementById("t1").value = txt.USD.promedio;
       document.getElementById("t2").value = txt.USD.sicad2;
       refresca();
  }

function showErrorD(err) { 
      console.log('muestor error', err);
    }
}

Fecha_precios();

//descarga_historico();
function descarga_historico(){
var nomb="https://bdeabreu66.github.io/historico/historico.txt";
//var myHeaders = new Headers();
var myInit = { mode: 'cors' };
fetch(nomb,myInit)
        .then(ajaxPositiveD)
        .catch(showErrorD);

function ajaxPositiveD(response) {
      console.log('response.ok: ', response.ok);
      if(response.ok) {
        response.json().then(showResultD);
      } else {
        showErrorD('status code: ' + response.status);
      }
    }
 function showResultD(txt) {
       console.log('muestro respuesta: ', txt);
        Historico=txt;
 //console.log(fecha_actual());
        var ind=Historico.findIndex(elemento => elemento.fecha==fecha_actual());
        if (ind>=0) { document.getElementById("t2").value =Historico[ind].bcv; localStorage.setItem('p2',Historico[ind].bcv);}
          else {alert('Dolar no actualizado')}
 }
function showErrorD(err) {
 console.log('muestor error', err); 
  }
 
  

}

function Fecha_precios(){
var nomb="https://bdeabreu66.github.io/factura/fecha.txt";


//var myHeaders = new Headers();
var myInit = { mode: 'cors' };

fetch(nomb,myInit)
        .then(ajaxPositiveD)
        .catch(showErrorD);

function ajaxPositiveD(response) {
      console.log('response.ok: ', response.ok);
      if(response.ok) {
        response.json().then(showResultD);
      } else {
        showErrorD('status code: ' + response.status);
      }
    }
 function showResultD(txt) {
       //console.log('fecha: '+ txt.dia+txt.mes+txt.ano);
      // document.getElementById("t1").value = txt.USD.promedio;
     //    document.getElementById("t2").value = txt.USD.sicad2;
      var fecha='('+txt.dia+'/'+txt.mes+'/'+txt.ano+')';
      document.getElementById("fecha_p").innerText=fecha;
      localStorage.setItem('FECHA_P',fecha);
  //  refresca();
  }

function showErrorD(err) { 
      console.log('muestor error', err);
    }

}


</script>
</BODY>
</html>